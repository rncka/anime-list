<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ì• ë‹ˆë¦¬ìŠ¤íŠ¸</title>

  <link rel="apple-touch-icon" href="icon_512.png" />
  <link rel="icon" type="image/png" href="icon_512.png" />

  <style>
    /* ===== 1. ë””ìì¸ ë³€ìˆ˜ (ë‹¤í¬ëª¨ë“œ ë¶€í™œ!) ===== */
    :root[data-theme="light"] {
      --bg-app: #f8fafc; --bg-surface: #ffffff; --bg-surface-alt: #f1f5f9;
      --text-primary: #1e293b; --text-secondary: #64748b;
      --border-color: #e2e8f0; --accent-color: #6366f1; --accent-hover: #4f46e5;
      --danger-color: #ef4444; --success-text: #166534;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :root[data-theme="dark"] {
      --bg-app: #0f172a; --bg-surface: #1e293b; --bg-surface-alt: #334155;
      --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --border-color: #334155; --accent-color: #818cf8; --accent-hover: #a5b4fc;
      --danger-color: #f87171; --success-text: #4ade80;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4);
    }

    /* ===== 2. ê¸°ë³¸ ìŠ¤íƒ€ì¼ ===== */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: "Pretendard", system-ui, sans-serif; padding: 0; margin: 0;
      background-color: var(--bg-app); color: var(--text-primary);
      overflow-x: hidden; transition: background-color 0.3s, color 0.3s;
    }
    .app { max-width: 600px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }

    /* ===== 3. ìŠ¤ë§ˆíŠ¸ í—¤ë” (ì ‘íˆëŠ” ê¸°ëŠ¥ ìœ ì§€) ===== */
    .sticky-header-container {
      position: sticky; top: 0; z-index: 100;
      background-color: var(--bg-app);
      padding: 10px 20px; margin: 0 -20px;
      transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
    }
    .sticky-header-container.scrolled { background-color: var(--bg-surface); box-shadow: var(--shadow-sm); }
    .sticky-header-container.nav-up { transform: translateY(-100%); }

    .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    h1 { font-size: 22px; margin: 0; font-weight: 800; background: linear-gradient(135deg, var(--accent-color), var(--accent-hover)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    /* ===== 4. ì…ë ¥ ì˜ì—­ & íˆ´ë°” ===== */
    .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    input, select, button, textarea {
      font-size: 14px; padding: 10px; border-radius: 12px;
      border: 1px solid var(--border-color); background: var(--bg-surface); color: var(--text-primary); outline: none;
    }
    input { flex: 1; }
    button { background: var(--accent-color); color: white; border: none; font-weight: 600; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    /* ì‚¬ì§„ ë²„íŠ¼ ë””ìì¸ */
    .file-label {
      padding: 10px 14px; background: var(--bg-surface-alt); border: 1px solid var(--border-color);
      border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 18px; min-width: 44px;
    }
    .file-preview-name { display: none; }

    .toolbar { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0; }
    .toolbar select, .toolbar input { padding: 6px 10px; font-size: 13px; border-radius: 8px; flex-shrink: 0; }
    .stats { font-size: 12px; color: var(--text-secondary); text-align: right; margin-top: 8px; }

    /* ===== 5. ë¦¬ìŠ¤íŠ¸ & ì¹´ë“œ ë””ìì¸ (ì˜ˆì „ ì˜ˆìœ ë””ìì¸) ===== */
    .grid { display: flex; flex-direction: column; gap: 16px; margin-top: 16px; }
    .card {
      background: var(--bg-surface); border-radius: 16px; padding: 16px;
      box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
      display: flex; gap: 12px; align-items: flex-start;
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

    /* ì¸ë„¤ì¼ ì´ë¯¸ì§€ */
    .card-thumb {
      width: 70px; height: 100px; border-radius: 8px; object-fit: cover; flex-shrink: 0;
      background: var(--bg-surface-alt); border: 1px solid var(--border-color);
    }

    .card-content { flex: 1; display: flex; flex-direction: column; gap: 8px; min-width: 0; }
    
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .card-title { font-size: 16px; font-weight: 700; line-height: 1.3; }
    .card-meta { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

    .status-chip { font-size: 11px; padding: 3px 8px; border-radius: 12px; font-weight: 700; white-space: nowrap; margin-left: 8px; }
    .status-chip.O { background: var(--success-text); color: white; opacity: 0.8; }
    .status-chip.W { background: #eab308; color: white; }
    .status-chip.X { background: var(--border-color); color: var(--text-secondary); }

    .card-controls { display: flex; gap: 6px; flex-wrap: wrap; }
    .wheel-select { padding: 4px 8px; font-size: 12px; }
    .plus-one-btn { padding: 4px 8px !important; font-size: 11px !important; background: var(--bg-surface-alt); color: var(--accent-color); border: 1px solid var(--accent-color); }
    
    .memo-box { width: 100%; font-size: 12px; background: var(--bg-surface-alt); border: none; padding: 6px; border-radius: 8px; resize: none; }
    .card-footer { display: flex; justify-content: space-between; margin-top: 4px; font-size: 11px; color: var(--text-secondary); }
    .del-btn { padding: 4px 8px; font-size: 11px; background: transparent; color: var(--danger-color); border: 1px solid var(--danger-color); border-radius: 6px; }

    /* ë¡œë”©ë°”, í† ìŠ¤íŠ¸, ë¹ˆí™”ë©´ */
    .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--accent-color); border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 300px; pointer-events: none; }
    .toast { background: rgba(0,0,0,0.85); color: white; padding: 12px 16px; border-radius: 20px; font-size: 13px; text-align: center; animation: slideUp 0.3s; backdrop-filter: blur(4px); }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .empty { text-align: center; padding: 40px; color: var(--text-secondary); font-size: 14px; background: var(--bg-surface-alt); border-radius: 16px; }
  </style>
</head>
<body>

<div class="app">
  <div class="sticky-header-container">
    <header class="app-header">
      <h1>ì• ë‹ˆë¦¬ìŠ¤íŠ¸</h1>
      <div>
        <select id="themeSelect" style="padding: 6px;">
          <option value="system">ìë™</option>
          <option value="dark">ğŸŒ™</option>
          <option value="light">â˜€ï¸</option>
        </select>
        <button id="clearAllBtn" class="del-btn" style="border:none;">ì´ˆê¸°í™”</button>
      </div>
    </header>

    <section>
      <div class="input-row">
        <label for="fileInput" class="file-label">ğŸ“·</label>
        <input type="file" id="fileInput" accept="image/*" style="display: none;" />
        <span id="fileNameDisplay" class="file-preview-name"></span>

        <input id="titleInput" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
      </div>
      
      <div class="input-row">
        <input id="episodeInput" placeholder="1ê¸° 3í™”" style="flex:1;" />
        <select id="seenInput" style="flex:0.8;">
          <option value="W" selected>ë³´ëŠ”ì¤‘</option>
          <option value="O">ì™„ë£Œ</option>
          <option value="X">ì•ˆë´„</option>
        </select>
        <button id="addBtn" style="flex:0.8;">ì¶”ê°€</button>
      </div>

      <div class="toolbar">
        <input id="searchInput" placeholder="ğŸ” ê²€ìƒ‰" style="flex:2;" />
        <select id="statusFilter"><option value="ALL">ì „ì²´</option><option value="W">ë³´ëŠ”ì¤‘</option><option value="O">ì™„ë£Œ</option></select>
        <select id="sortSelect"><option value="new">ìµœì‹ ìˆœ</option><option value="name">ì´ë¦„ìˆœ</option></select>
      </div>
      <div class="stats" id="statsSummary"></div>
    </section>
  </div>

  <section id="grid" class="grid"></section>
  <div id="empty" class="empty" style="display:none;">ì‘í’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>
</div>

<div id="toast-container"></div>
<div class="scroll-buttons" style="position:fixed; bottom:20px; right:20px; display:flex; flex-direction:column; gap:10px;">
    <button id="scrollTopBtn" style="width:40px; height:40px; border-radius:50%; padding:0;">â†‘</button>
    <button id="scrollBottomBtn" style="width:40px; height:40px; border-radius:50%; padding:0;">â†“</button>
</div>

<script type="module">
  // ===== 1. ì„¤ì • (Storage ì œê±° & Firestoreë§Œ ì‚¬ìš©) =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyDpbP8aBRqOQtLNLDbtrly49ozPon4SQaWE",
      authDomain: "anime-list-85c9e.firebaseapp.com",
      projectId: "anime-list-85c9e",
      storageBucket: "anime-list-85c9e.firebasestorage.app",
      messagingSenderId: "397442929562",
      appId: "1:397442929562:web:1b5e3e90cbbfa8a573d8e51"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  // â˜… ì¤‘ìš”: ì˜ˆì „ ë°ì´í„°ê°€ ìˆëŠ” í´ë”(animes)ë¡œ ì—°ê²°! â˜…
  const itemsCol = collection(db, "animes");

  // ===== 2. ìƒíƒœ & DOM =====
  let items = [], sortMode = "new", filterStatus = "ALL", searchQuery = "";
  
  const addBtn = document.getElementById("addBtn");
  const fileInput = document.getElementById("fileInput");
  const fileNameDisplay = document.getElementById("fileNameDisplay");
  const grid = document.getElementById("grid");
  const header = document.querySelector(".sticky-header-container");
  
  fileInput.addEventListener("change", (e) => {
    if(e.target.files[0]) {
        addBtn.innerText = "ì‚¬ì§„ ì¤€ë¹„ë¨";
    }
  });

  function showToast(msg) {
    const t = document.createElement("div"); t.className = "toast"; t.innerText = msg;
    document.getElementById("toast-container").appendChild(t);
    setTimeout(() => t.remove(), 2500);
  }

  // ===== 3. ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜ (ë¬´ë£Œ Base64 ë°©ì‹) =====
  function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement("canvas");
                const MAX_WIDTH = 300; // ì¸ë„¤ì¼ í¬ê¸° ì œí•œ
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                resolve(canvas.toDataURL("image/jpeg", 0.7)); 
            }
        }
    });
  }

  // ===== 4. ì¶”ê°€ ë¡œì§ (ì‚¬ì§„ í¬í•¨) =====
  addBtn.addEventListener("click", async () => {
    const title = document.getElementById("titleInput").value.trim();
    if (!title) return showToast("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”!");

    addBtn.disabled = true;
    addBtn.innerHTML = `<span class="loader"></span>ì €ì¥ì¤‘`;

    try {
        let imageUrl = "";
        // ì‚¬ì§„ì´ ìˆë‹¤ë©´ ì••ì¶•í•´ì„œ ê¸€ìë¡œ ë³€í™˜
        if (fileInput.files[0]) {
            imageUrl = await compressImage(fileInput.files[0]);
        }

        await addDoc(itemsCol, {
            title, 
            episodeText: document.getElementById("episodeInput").value.trim(), 
            seen: document.getElementById("seenInput").value, 
            memo: "",
            imageUrl: imageUrl, // ë³€í™˜ëœ ì´ë¯¸ì§€ ì €ì¥
            createdAt: Date.now()
        });

        showToast("ì €ì¥ ì™„ë£Œ!");
        document.getElementById("titleInput").value = "";
        document.getElementById("episodeInput").value = "";
        fileInput.value = ""; 
        addBtn.innerText = "ì¶”ê°€";

    } catch (e) {
        console.error(e);
        showToast("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
        addBtn.disabled = false;
        if(addBtn.innerText !== "ì¶”ê°€") addBtn.innerText = "ì¶”ê°€";
    }
  });

  // ===== 5. ì‚­ì œ ë° ìˆ˜ì • (window ì „ì—­ í•¨ìˆ˜) =====
  window.deleteItem = async (id) => {
    if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    await deleteDoc(doc(db, "animes", id));
    showToast("ì‚­ì œë¨");
  };

  window.updateSeen = async (id, val) => updateDoc(doc(db, "animes", id), { seen: val });
  window.updateMemo = async (id, val) => updateDoc(doc(db, "animes", id), { memo: val });
  
  window.plusOne = async (id, text) => {
    let num = text.match(/\d+/g);
    if(num) {
        let lastNum = parseInt(num[num.length-1]);
        let newText = text.replace(lastNum, lastNum + 1);
        await updateDoc(doc(db, "animes", id), { episodeText: newText, seen: 'W' });
        showToast("+1í™” ì™„ë£Œ!");
    } else {
        showToast("ìˆ«ìê°€ ì—†ì–´ +1 ë¶ˆê°€");
    }
  };

  // ===== 6. ë Œë”ë§ (ë””ìì¸ ë³µêµ¬) =====
  onSnapshot(query(itemsCol, orderBy("createdAt", "desc")), (snap) => {
    items = []; snap.forEach(d => items.push({id: d.id, ...d.data()}));
    render();
  });

  function render() {
    grid.innerHTML = "";
    let display = items.filter(i => 
        (filterStatus === "ALL" || i.seen === filterStatus) &&
        i.title.toLowerCase().includes(searchQuery)
    );

    if(sortMode === "name") display.sort((a,b) => a.title.localeCompare(b.title));
    else display.sort((a,b) => b.createdAt - a.createdAt);

    document.getElementById("statsSummary").innerText = `ì´ ${display.length}ê°œ`;
    document.getElementById("empty").style.display = display.length ? "none" : "block";

    display.forEach(item => {
        const div = document.createElement("div"); div.className = "card";
        
        // ì´ë¯¸ì§€ ì²˜ë¦¬
        const imgHtml = item.imageUrl 
            ? `<img src="${item.imageUrl}" class="card-thumb" onclick="window.open('${item.imageUrl}')">`
            : `<div class="card-thumb" style="display:flex;align-items:center;justify-content:center;color:#ccc;font-size:24px;">ğŸ“º</div>`;

        // ì´ì „ ë°ì´í„° í˜¸í™˜ì„± ì²´í¬
        const seenVal = item.seen || 'W';
        const epText = item.episodeText || 'íšŒì°¨ ì •ë³´ ì—†ìŒ';

        div.innerHTML = `
            ${imgHtml}
            <div class="card-content">
                <div class="card-header">
                    <div style="display:flex; align-items:center;">
                        <span class="card-title">${item.title}</span>
                        <span class="status-chip ${seenVal}">${seenVal==='O'?'ì™„ë£Œ':seenVal==='W'?'ì‹œì²­ì¤‘':'ì•ˆë´„'}</span>
                    </div>
                </div>
                
                <div class="card-meta">${epText}</div>
                
                <div class="card-controls">
                    <button class="plus-one-btn" onclick="plusOne('${item.id}', '${epText}')">+1í™”</button>
                    <select class="wheel-select" onchange="updateSeen('${item.id}', this.value)">
                        <option value="W" ${seenVal==='W'?'selected':''}>ë³´ëŠ”ì¤‘</option>
                        <option value="O" ${seenVal==='O'?'selected':''}>ì™„ë£Œ</option>
                        <option value="X" ${seenVal==='X'?'selected':''}>ì•ˆë´„</option>
                    </select>
                </div>

                <textarea class="memo-box" placeholder="ë©”ëª¨..." onchange="updateMemo('${item.id}', this.value)">${item.memo||''}</textarea>
                
                <div class="card-footer">
                    <span>${new Date(item.createdAt).toLocaleDateString()}</span>
                    <button class="del-btn" onclick="deleteItem('${item.id}')">ì‚­ì œ</button>
                </div>
            </div>
        `;
        grid.appendChild(div);
    });
  }

  // ===== 7. ê¸°íƒ€ ê¸°ëŠ¥ ë³µêµ¬ (í•„í„°, ìŠ¤í¬ë¡¤, í…Œë§ˆ) =====
  document.getElementById("searchInput").addEventListener("input", e => { searchQuery=e.target.value.toLowerCase(); render(); });
  document.getElementById("statusFilter").addEventListener("change", e => { filterStatus=e.target.value; render(); });
  document.getElementById("sortSelect").addEventListener("change", e => { sortMode=e.target.value; render(); });
  
  // ìŠ¤ë§ˆíŠ¸ í—¤ë”
  let lastScroll = 0;
  window.addEventListener("scroll", () => {
    const current = window.scrollY;
    if(current > 10) header.classList.add("scrolled"); else header.classList.remove("scrolled");
    if(current > lastScroll && current > 50) header.classList.add("nav-up");
    else header.classList.remove("nav-up");
    lastScroll = current;
  });

  // í…Œë§ˆ
  const themeSel = document.getElementById("themeSelect");
  themeSel.addEventListener("change", e => {
      document.documentElement.setAttribute("data-theme", e.target.value);
      localStorage.setItem("theme", e.target.value);
  });
  const savedTheme = localStorage.getItem("theme") || "system";
  document.documentElement.setAttribute("data-theme", savedTheme);
  themeSel.value = savedTheme;

  // ì „ì²´ ì‚­ì œ
  document.getElementById("clearAllBtn").addEventListener("click", async () => {
      if(!confirm("ì •ë§ ë‹¤ ì§€ìš¸ê¹Œìš”?")) return;
      const snap = await getDocs(itemsCol);
      snap.forEach(d => deleteDoc(d.ref));
      showToast("ì´ˆê¸°í™”ë¨");
  });

  document.getElementById("scrollTopBtn").addEventListener("click", () => window.scrollTo({top:0, behavior:'smooth'}));
  document.getElementById("scrollBottomBtn").addEventListener("click", () => window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}));

</script>
</body>
</html>
