<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>애니리스트</title>

  <link rel="apple-touch-icon" href="icon_512.png" />
  <link rel="icon" type="image/png" href="icon_512.png" />

  <style>
    :root[data-theme="light"] {
      --bg: #f3f4f6;
      --text: #111827;
      --subtext: #4b5563;
      --row-bg: #ffffff;
      --border: #e5e7eb;
      --accent: #38bdf8;
      --danger: #f97373;
      --status-done: #dcfce7;
      --status-watching: #fef9c3;
      --status-not: #fee2e2;
      --chip-text: #111827;
    }

    :root[data-theme="dark"] {
      --bg: #020617;
      --text: #e5e7eb;
      --subtext: #9ca3af;
      --row-bg: #020617;
      --border: #1e293b;
      --accent: #38bdf8;
      --danger: #f97373;
      --status-done: #14532d;
      --status-watching: #78350f;
      --status-not: #7f1d1d;
      --chip-text: #f9fafb;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 20px;
      margin: 0;
      background: radial-gradient(circle at top, #0f172a 0, var(--bg) 45%);
      color: var(--text);
    }

    .app { max-width: 980px; margin: 0 auto; }

    /* 제목 가운데 */
    .app-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: 0.08em;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* 입력 */
    .controls { margin-bottom: 12px; }
    .input-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }

    input, select, button {
      font-size: 13px;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--row-bg);
      color: var(--text);
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      padding-inline: 14px;
      font-weight: 500;
    }

    button.danger { background: #b91c1c; }

    /* 리스트 */
    .grid {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      display: grid;
      grid-template-columns: 2.6fr 2.2fr 1.4fr;
      gap: 8px 12px;
      padding: 10px 12px;
      background: var(--row-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      animation: fadeInUp 0.22s ease-out;
    }

    .card-header { display: flex; flex-direction: column; gap: 4px; }
    .card-title { font-size: 15px; font-weight: 600; }
    .card-meta { font-size: 12px; color: var(--subtext); }

    .status-chip {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      display: inline-block;
    }
    .done { background: var(--status-done); color: var(--chip-text); }
    .watching { background: var(--status-watching); color: var(--chip-text); }
    .not { background: var(--status-not); color: var(--chip-text); }

    .episode-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .episode-label {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 999px;
      background: rgba(148,163,184,0.2);
      color: var(--subtext);
    }

    .wheel-select {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .empty {
      margin-top: 16px;
      color: var(--subtext);
      text-align: center;
    }

    /* 상태 탭 */
    .status-tabs {
      display: inline-flex;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid var(--border);
      padding: 2px;
      gap: 2px;
    }

    .status-tab {
      background: transparent;
      border: none;
      color: var(--subtext);
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
    }

    .status-tab.active {
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="app-header">
      <h1>애니리스트</h1>
      <div class="header-actions">
        <select id="themeSelect">
          <option value="light">라이트 모드</option>
          <option value="dark">다크 모드</option>
        </select>
        <button class="danger" onclick="clearAll()">전체 삭제</button>
      </div>
    </div>

    <div class="controls">
      <div class="input-row">
        <input id="title" placeholder="작품 이름" />
        <input id="episode" placeholder="회차 (예: 1기 3화)" />
        <select id="seen">
          <option value="O">O · 다 봄</option>
          <option value="W">△ · 보는 중</option>
          <option value="X">X · 안 봄</option>
        </select>
        <input id="type" placeholder="메모" />
        <button onclick="addItem()">+ 추가</button>
      </div>

      <div class="input-row">
        <input id="search" placeholder="제목 검색" />

        <select id="sort">
          <option value="createdDesc">최근 추가순</option>
          <option value="titleAsc">이름순</option>
        </select>

        <!-- 상태 탭 -->
        <div class="status-tabs">
          <button class="status-tab active" data-status="ALL">전체</button>
          <button class="status-tab" data-status="W">보는 중</button>
          <button class="status-tab" data-status="O">다 봄</button>
        </div>

        <select id="filter">
          <option value="ALL">전체</option>
          <option value="O">O · 다 봄</option>
          <option value="W">△ · 보는 중</option>
          <option value="X">X · 안 봄</option>
        </select>

        <span class="badge" id="countBadge"></span>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty">데이터가 없습니다.</div>
  </div>

  <script type="module">
    /* ===== Firebase ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot,
      query, orderBy, doc, updateDoc, deleteDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpbP8aBRqOQtLNLDbtrly49ozPon4SQaWE",
      authDomain: "anime-list-85c9e.firebaseapp.com",
      projectId: "anime-list-85c9e",
      storageBucket: "anime-list-85c9e.firebasestorage.app",
      messagingSenderId: "397442929562",
      appId: "1:397442929562:web:1b5e3e90cbbfa8a573d8e51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const itemsCol = collection(db, "animeItems");

    let items = [];
    let sortMode = "createdDesc";
    let filterStatus = "ALL";
    let searchQuery = "";

    const titleInput = document.getElementById("title");
    const episodeRawInput = document.getElementById("episode");
    const seenInput = document.getElementById("seen");
    const typeInput = document.getElementById("type");
    const filterSelect = document.getElementById("filter");
    const statusTabs = document.querySelectorAll(".status-tab");
    const themeSelect = document.getElementById("themeSelect");
    const countBadge = document.getElementById("countBadge");

    /* ===== 테마 ===== */
    function setTheme(t) {
      document.documentElement.setAttribute("data-theme", t);
      localStorage.setItem("theme", t);
    }
    const saved = localStorage.getItem("theme") || "dark";
    setTheme(saved);
    themeSelect.value = saved;
    themeSelect.addEventListener("change", (e)=>setTheme(e.target.value));

    /* ===== 회차 파싱 ===== */
    function parseEpisode(raw) {
      if (!raw) return { season: null, episodeNum: null, display: "" };
      const sMatch = raw.match(/(\d+)\s*기/);
      const hMatch = raw.match(/(\d+)\s*화/);
      const season = sMatch ? parseInt(sMatch[1]) : null;
      const ep = hMatch ? parseInt(hMatch[1]) : null;
      const display = (season ? `${season}기 ` : "") + (ep ? `${ep}화` : "");
      return { season, episodeNum: ep, display };
    }

    function formatEpisode(season, ep) {
      if (!season && !ep) return "";
      let t = "";
      if (season) t += `${season}기 `;
      if (ep) t += `${ep}화`;
      return t.trim();
    }

    /* ===== Firestore 구독 ===== */
    const q = query(itemsCol, orderBy("createdAt", "asc"));
    onSnapshot(q, snap => {
      items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      render();
    });

    /* ===== 아이템 추가 ===== */
    window.addItem = async function () {
      const title = titleInput.value.trim();
      const rawEp = episodeRawInput.value.trim();
      if (!title) return alert("제목!");

      const parsed = parseEpisode(rawEp);

      await addDoc(itemsCol, {
        title,
        episode: parsed.display,
        season: parsed.season,
        episodeNum: parsed.episodeNum,
        seen: seenInput.value,
        type: typeInput.value.trim(),
        createdAt: Date.now()
      });

      titleInput.value = "";
      episodeRawInput.value = "";
      typeInput.value = "";
    };

    /* ===== 상태 변경 ===== */
    window.toggleSeen = async(id,v)=>{
      await updateDoc(doc(db,"animeItems",id),{seen:v});
    };

    /* ===== 시즌/회차 저장 ===== */
    async function saveEp(id, sVal, eVal) {
      const s = sVal ? parseInt(sVal) : null;
      const e = eVal ? parseInt(eVal) : null;
      await updateDoc(doc(db,"animeItems",id),{
        season:s, episodeNum:e, episode:formatEpisode(s,e)
      });
    }

    /* ===== 삭제 ===== */
    window.deleteItem = async(id)=>{
      if(!confirm("삭제?"))return;
      await deleteDoc(doc(db,"animeItems",id));
    };

    window.clearAll = async()=>{
      if(!confirm("전체 삭제?"))return;
      const snap=await getDocs(itemsCol);
      await Promise.all(snap.docs.map(d=>deleteDoc(d.ref)));
    };

    /* ===== 필터 ===== */
    statusTabs.forEach(btn => {
      btn.addEventListener("click", () => {
        filterStatus = btn.dataset.status;
        filterSelect.value = filterStatus;
        updateTabs();
        render();
      });
    });

    filterSelect.addEventListener("change", e => {
      filterStatus = e.target.value;
      updateTabs();
      render();
    });

    function updateTabs() {
      statusTabs.forEach(b => {
        b.classList.toggle("active", b.dataset.status === filterStatus);
      });
    }

    /* ===== 렌더링 ===== */
    function render() {
      const grid = document.getElementById("grid");
      const empty = document.getElementById("empty");
      grid.innerHTML = "";

      let arr = items.map(i=>({...i}));

      if(searchQuery) {
        arr = arr.filter(i => (i.title||"").toLowerCase().includes(searchQuery));
      }

      if(filterStatus!=="ALL") {
        arr = arr.filter(i=>i.seen===filterStatus);
      }

      arr.sort((a,b)=>{
        if(sortMode==="titleAsc")
          return (a.title||"").localeCompare(b.title||"","ko");
        return b.createdAt - a.createdAt;
      });

      countBadge.textContent = `전체 ${items.length} · O ${items.filter(i=>i.seen==="O").length} · △ ${items.filter(i=>i.seen==="W").length} · X ${items.filter(i=>i.seen==="X").length}`;

      if(arr.length===0){ empty.style.display="block"; return; }
      empty.style.display="none";

      arr.forEach(item=>{
        const parsed = parseEpisode(item.episode||"");
        const card = document.createElement("div");
        card.className="card";

        /* LEFT */
        const hd=document.createElement("div");
        hd.className="card-header";
        const t=document.createElement("div");
        t.className="card-title";
        t.textContent=item.title;
        const m=document.createElement("div");
        m.className="card-meta";
        m.textContent=parsed.display||"회차 정보 없음";
        const mem=document.createElement("div");
        mem.className="memo";
        mem.textContent=item.type||"";
        hd.appendChild(t);
        hd.appendChild(m);
        hd.appendChild(mem);

        /* MIDDLE */
        const mid=document.createElement("div");
        const chip=document.createElement("div");
        chip.className="status-chip "+(item.seen==="O"?"done":item.seen==="W"?"watching":"not");
        chip.textContent=item.seen==="O"?"다 봄":item.seen==="W"?"보는 중":"안 봄";

        const stRow=document.createElement("div");
        stRow.className="status-select-row";
        const sl=document.createElement("select");
        sl.innerHTML=`
          <option value="O" ${item.seen==="O"?"selected":""}>O · 다 봄</option>
          <option value="W" ${item.seen==="W"?"selected":""}>△ · 보는 중</option>
          <option value="X" ${item.seen==="X"?"selected":""}>X · 안 봄</option>`;
        sl.onchange=e=>toggleSeen(item.id,e.target.value);
        stRow.appendChild(sl);

        const epRow=document.createElement("div");
        epRow.className="episode-row";

        const lbl=document.createElement("span");
        lbl.className="episode-label";
        lbl.textContent="시즌/회차";

        const sSel=document.createElement("select");
        sSel.className="wheel-select";
        let Sopt=`<option value="">-</option>`;
        for(let i=1;i<=10;i++){
          Sopt+=`<option value="${i}" ${parsed.season===i?"selected":""}>${i}기</option>`;
        }
        sSel.innerHTML=Sopt;

        const eSel=document.createElement("select");
        eSel.className="wheel-select";
        let Eopt=`<option value="">-</option>`;
        for(let i=1;i<=200;i++){
          Eopt+=`<option value="${i}" ${parsed.episodeNum===i?"selected":""}>${i}화</option>`;
        }
        eSel.innerHTML=Eopt;

        const save=document.createElement("button");
        save.className="icon-btn";
        save.textContent="저장";

        save.onclick=()=>saveEp(item.id,sSel.value,eSel.value);
        sSel.onchange=()=>saveEp(item.id,sSel.value,eSel.value);
        eSel.onchange=()=>saveEp(item.id,sSel.value,eSel.value);

        epRow.appendChild(lbl);
        epRow.appendChild(sSel);
        epRow.appendChild(eSel);
        epRow.appendChild(save);

        mid.appendChild(chip);
        mid.appendChild(stRow);
        mid.appendChild(epRow);

        /* RIGHT */
        const ft=document.createElement("div");
        ft.className="card-footer";
        const tm=document.createElement("div");
        tm.className="card-meta";
        tm.textContent=new Date(item.createdAt).toLocaleString("ko-KR");

        const del=document.createElement("button");
        del.className="secondary small-btn";
        del.textContent="삭제";
        del.onclick=()=>deleteItem(item.id);

        ft.appendChild(tm);
        ft.appendChild(del);

        card.appendChild(hd);
        card.appendChild(mid);
        card.appendChild(ft);

        grid.appendChild(card);
      });
    }

    /* 검색 */
    document.getElementById("search").addEventListener("input",e=>{
      searchQuery=e.target.value.toLowerCase();
      render();
    });

    document.getElementById("sort").addEventListener("change",e=>{
      sortMode=e.target.value;
      render();
    });

    updateTabs();
  </script>
</body>
</html>
