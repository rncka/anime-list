<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ë‚´ ì†ì•ˆì˜ ì• ë‹ˆë¦¬ìŠ¤íŠ¸</title>

  <link rel="apple-touch-icon" href="icon_512.png" />
  <link rel="icon" type="image/png" href="icon_512.png" />

  <style>
    /* ===== 1. ë””ìì¸ ë³€ìˆ˜ ì„ ì–¸ ===== */
    :root[data-theme="light"] {
      --bg-app: #f8fafc;
      --bg-surface: #ffffff;
      --bg-surface-alt: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --accent-color: #6366f1;
      --accent-hover: #4f46e5;
      --danger-color: #ef4444;
      --success-bg: #dcfce7; --success-text: #166534;
      --warning-bg: #fef9c3; --warning-text: #854d0e;
      --error-bg: #fee2e2;   --error-text: #991b1b;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }

    :root[data-theme="dark"] {
      --bg-app: #0f172a;
      --bg-surface: #1e293b;
      --bg-surface-alt: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #334155;
      --accent-color: #818cf8;
      --accent-hover: #a5b4fc;
      --danger-color: #f87171;
      --success-bg: #052e16; --success-text: #4ade80;
      --warning-bg: #422006; --warning-text: #fde047;
      --error-bg: #450a0a;   --error-text: #f87171;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5);
    }

    /* ===== 2. ê¸°ë³¸ ìŠ¤íƒ€ì¼ ===== */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      padding: 0; margin: 0;
      background-color: var(--bg-app);
      color: var(--text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
      overflow-x: hidden;
    }
    .app { max-width: 800px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }

    /* ===== 3. ìŠ¤ë§ˆíŠ¸ ìƒë‹¨ í—¤ë” ===== */
    .sticky-header-container {
      position: sticky; top: 0; z-index: 100;
      background-color: var(--bg-app);
      padding-top: 20px; padding-bottom: 10px;
      margin-left: -20px; margin-right: -20px; padding-left: 20px; padding-right: 20px;
      border-bottom: 1px solid transparent;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s, box-shadow 0.3s;
    }
    .sticky-header-container.nav-up { transform: translateY(-100%); }
    .sticky-header-container.scrolled {
        border-bottom-color: var(--border-color);
        box-shadow: var(--shadow-sm);
        background-color: var(--bg-surface); 
    }

    .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    h1 { margin: 0; font-size: 24px; font-weight: 800; background: linear-gradient(135deg, var(--accent-color), var(--accent-hover)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header-actions { display: flex; gap: 8px; }

    /* ì…ë ¥ì°½ ë° ë„êµ¬ ëª¨ìŒ */
    .input-row { display: flex; gap: 8px; margin-bottom: 12px; }
    .input-row input { flex: 1; }

    input, select, button, textarea {
      font-family: inherit; font-size: 14px; padding: 10px 14px;
      border-radius: 12px; border: 1px solid var(--border-color);
      background: var(--bg-surface); color: var(--text-primary);
      outline: none; transition: all 0.2s ease;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

    button {
      cursor: pointer; font-weight: 600; border: none;
      background: var(--accent-color); color: white;
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    }
    button:hover { background: var(--accent-hover); transform: translateY(-1px); }
    button.secondary { background: var(--bg-surface-alt); color: var(--text-secondary); border: 1px solid var(--border-color); }
    button.danger { background: #fee2e2; color: var(--danger-color); border: 1px solid #fecaca; }
    
    .plus-one-btn {
        padding: 6px 10px !important; font-size: 12px !important;
        background: var(--bg-surface-alt) !important; color: var(--accent-color) !important;
        border: 1px solid var(--border-color) !important; border-radius: 8px !important; font-weight: 700 !important;
    }
    .plus-one-btn:hover { background: var(--accent-color) !important; color: white !important; }

    .toolbar { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between; background: var(--bg-surface-alt); padding: 12px; border-radius: 16px; }
    .toolbar-group { display: flex; align-items: center; gap: 8px; flex: 1; }
    .toolbar-group label { font-size: 12px; font-weight: 600; color: var(--text-secondary); white-space: nowrap; }
    .stats { font-size: 13px; font-weight: 500; color: var(--text-secondary); white-space: nowrap; margin-left: auto; }

    /* ===== 4. ë¦¬ìŠ¤íŠ¸ & ì¹´ë“œ (ì‚¬ì§„ ê´€ë ¨ ìŠ¤íƒ€ì¼ ì œê±°ë¨) ===== */
    .grid { display: flex; flex-direction: column; gap: 16px; margin-top: 20px; }
    @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .card {
      background: var(--bg-surface); border-radius: 20px; padding: 20px;
      box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
      animation: slideUpFade 0.3s ease-out forwards;
      display: flex; flex-direction: column; gap: 16px; /* ì„¸ë¡œ ì •ë ¬ë¡œ ë³µê·€ */
    }
    .card-header-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
    .card-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; line-height: 1.3; }
    .card-subtitle { font-size: 13px; color: var(--text-secondary); }

    .status-chip { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; white-space: nowrap; }
    .status-chip.done { background: var(--success-bg); color: var(--success-text); }
    .status-chip.watching { background: var(--warning-bg); color: var(--warning-text); }
    .status-chip.not { background: var(--error-bg); color: var(--error-text); }

    .card-controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; padding: 12px; background: var(--bg-surface-alt); border-radius: 12px; }
    .control-group { display: flex; align-items: center; gap: 6px; }
    .control-label { font-size: 12px; color: var(--text-secondary); font-weight: 600; }
    .wheel-select { padding: 6px 10px; font-size: 13px; border-radius: 8px; background: var(--bg-surface); cursor: pointer; }

    .memo { width: 100%; resize: vertical; min-height: 40px; border-radius: 12px; font-size: 13px; background: var(--bg-surface-alt); border: none; }
    .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; font-size: 12px; color: var(--text-secondary); }
    .empty { text-align: center; padding: 40px; color: var(--text-secondary); font-size: 15px; background: var(--bg-surface-alt); border-radius: 20px; border: 2px dashed var(--border-color); }

    /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
    .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--accent-color); border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ìŠ¤í¬ë¡¤ ë²„íŠ¼ & í† ìŠ¤íŠ¸ */
    .scroll-buttons { position: fixed; right: 20px; bottom: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 50; }
    .scroll-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--bg-surface); color: var(--text-primary); border: 1px solid var(--border-color); box-shadow: var(--shadow-md); font-size: 18px; padding: 0; }
    
    #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
    .toast { background: var(--bg-surface); color: var(--text-primary); padding: 14px 20px; border-radius: 16px; box-shadow: var(--shadow-lg); font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 10px; animation: toastSlideUp 0.3s ease-out forwards; border: 1px solid var(--border-color); pointer-events: auto;}
    .toast.success { border-left: 4px solid var(--success-text); }
    .toast.error { border-left: 4px solid var(--error-text); }
    @keyframes toastSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastFadeOut { to { opacity: 0; transform: translateY(-20px); } }

    @media (max-width: 640px) {
      .app { padding: 16px; }
      .sticky-header-container { margin-left: -16px; margin-right: -16px; padding-left: 16px; padding-right: 16px;}
      .input-row { flex-direction: column; }
      .input-row input, .input-row select, .input-row button { width: 100%; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .stats { margin-left: 0; text-align: center; margin-top: 8px; }
      .card-controls { flex-direction: column; align-items: stretch; }
      .control-group { justify-content: space-between; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sticky-header-container">
        <header class="app-header">
        <h1>ë‚´ ì• ë‹ˆë¦¬ìŠ¤íŠ¸</h1>
        <div class="header-actions">
            <select id="themeSelect">
            <option value="system">ìë™ í…Œë§ˆ</option>
            <option value="light">â˜€ï¸ ë¼ì´íŠ¸</option>
            <option value="dark">ğŸŒ™ ë‹¤í¬</option>
            </select>
            <button id="clearAllBtn" class="secondary danger small-btn">ì „ì²´ ì‚­ì œ</button>
        </div>
        </header>

        <section class="controls">
        <div class="input-row">
            <input id="titleInput" placeholder="ì‘í’ˆ ì œëª© (ì˜ˆ: ìµœì• ì˜ ì•„ì´)" />
        </div>
        
        <div class="input-row">
            <input id="episodeInput" placeholder="íšŒì°¨ (ì˜ˆ: 1ê¸° 3í™”)" style="flex: 0.6;" />
            <select id="seenInput" style="flex: 0.5;">
            <option value="O">âœ… ë‹¤ ë´„</option>
            <option value="W" selected>ğŸ‘€ ë³´ëŠ” ì¤‘</option>
            <option value="X">âŒ ì•ˆ ë´„</option>
            </select>
            <button id="addBtn" style="flex: 0.4;">+ ì¶”ê°€í•˜ê¸°</button>
        </div>
        
        <div class="input-row">
            <textarea id="memoInput" rows="1" placeholder="ì§§ì€ ë©”ëª¨..."></textarea>
        </div>

        <div class="toolbar">
            <div class="toolbar-group" style="flex: 2;">
            <input id="searchInput" placeholder="ğŸ” ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..." style="width: 100%;" />
            </div>
            <div class="toolbar-group">
            <select id="sortSelect">
                <option value="createdDesc">ğŸ“… ìµœì‹ ìˆœ</option>
                <option value="titleAsc">ğŸ”¤ ì´ë¦„ìˆœ</option>
            </select>
            <select id="statusFilter">
                <option value="ALL">ì „ì²´ ìƒíƒœ</option>
                <option value="O">âœ… ì™„ë£Œ</option>
                <option value="W">ğŸ‘€ ë³´ëŠ” ì¤‘</option>
                <option value="X">âŒ ë¯¸ì‹œì²­</option>
            </select>
            </div>
            <div class="stats" id="statsSummary"></div>
        </div>
        </section>
    </div>

    <section id="grid" class="grid"></section>
    <div id="empty" class="empty" style="display:none;">
        ğŸ“º ì•„ì§ ì¶”ê°€ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì—ì„œ ìƒˆë¡œìš´ ì• ë‹ˆë©”ì´ì…˜ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!
    </div>
  </div>

  <div class="scroll-buttons">
    <button id="scrollTopBtn" class="scroll-btn">â†‘</button>
    <button id="scrollBottomBtn" class="scroll-btn">â†“</button>
  </div>
  <div id="toast-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpbP8aBRqOQtLNLDbtrly49ozPon4SQaWE",
      authDomain: "anime-list-85c9e.firebaseapp.com",
      projectId: "anime-list-85c9e",
      storageBucket: "anime-list-85c9e.firebasestorage.app",
      messagingSenderId: "397442929562",
      appId: "1:397442929562:web:1b5e3e90cbbfa8a573d8e51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const itemsCol = collection(db, "animeItems");

    let items = [], sortMode = "createdDesc", filterStatus = "ALL", searchQuery = "";

    const themeSelect = document.getElementById("themeSelect");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const addBtn = document.getElementById("addBtn");
    const titleInput = document.getElementById("titleInput");
    const episodeInput = document.getElementById("episodeInput");
    const seenInput = document.getElementById("seenInput");
    const memoInput = document.getElementById("memoInput");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const statusFilter = document.getElementById("statusFilter");
    const grid = document.getElementById("grid");
    const emptyEl = document.getElementById("empty");
    const statsSummary = document.getElementById("statsSummary");
    const scrollTopBtn = document.getElementById("scrollTopBtn");
    const scrollBottomBtn = document.getElementById("scrollBottomBtn");
    const stickyHeader = document.querySelector('.sticky-header-container');
    const toastContainer = document.getElementById('toast-container');

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icon = type === 'success' ? 'âœ…' : 'âš ï¸';
        toast.innerHTML = `<span>${icon}</span> ${message}`;
        toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'toastFadeOut 0.3s ease-out forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ìŠ¤ë§ˆíŠ¸ í—¤ë” ë¡œì§
    let lastScrollTop = 0;
    const delta = 5;
    window.addEventListener('scroll', () => {
        const st = window.scrollY;
        if (st > 10) stickyHeader.classList.add('scrolled');
        else stickyHeader.classList.remove('scrolled');
        if (Math.abs(lastScrollTop - st) <= delta) return;
        if (st > lastScrollTop && st > 50) stickyHeader.classList.add('nav-up');
        else stickyHeader.classList.remove('nav-up');
        lastScrollTop = st;
    });

    // í…Œë§ˆ ì„¤ì •
    function applyTheme(mode) {
      const root = document.documentElement;
      if (mode === "system") {
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        root.setAttribute("data-theme", prefersDark ? "dark" : "light");
      } else {
        root.setAttribute("data-theme", mode);
      }
      localStorage.setItem("animeListTheme", mode);
    }
    const storedTheme = localStorage.getItem("animeListTheme") || "system";
    themeSelect.value = storedTheme;
    applyTheme(storedTheme);
    themeSelect.addEventListener("change", (e) => applyTheme(e.target.value));

    scrollTopBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
    scrollBottomBtn.addEventListener("click", () => window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" }));

    function getCreatedAtMs(item) {
      const v = item.createdAt;
      if (!v) return 0;
      if (typeof v === "number") return v;
      if (v.toMillis) return v.toMillis();
      return 0;
    }
    function normalizeSeen(item) {
      const v = (item.seen || "X").toUpperCase();
      return ["O", "W", "X"].includes(v) ? v : "X";
    }
    function buildEpisodeText(season, episodeNum) {
      if (!season && !episodeNum) return "";
      const sPart = season ? `${season}ê¸°` : "";
      const ePart = episodeNum ? `${episodeNum}í™”` : "";
      return [sPart, ePart].filter(Boolean).join(" ");
    }
    function parseEpisodeInput(text) {
      if (!text) return { season: null, episodeNum: null };
      const cleaned = text.replace(/\s+/g, "").trim();
      let match = cleaned.match(/(\d+)\s*ê¸°\s*(\d+)\s*í™”?/);
      if (match) return { season: Number(match[1]), episodeNum: Number(match[2]) };
      match = cleaned.match(/(\d+)\s*ê¸°/);
      if (match) return { season: Number(match[1]), episodeNum: null };
      match = cleaned.match(/(\d+)\s*í™”/);
      if (match) return { season: null, episodeNum: Number(match[1]) };
      match = cleaned.match(/^(\d+)$/);
      if (match) return { season: null, episodeNum: Number(match[1]) };
      return { season: null, episodeNum: null };
    }

    onSnapshot(query(itemsCol, orderBy("createdAt", "asc")), (snapshot) => {
      items = [];
      snapshot.forEach((docSnap) => items.push({ id: docSnap.id, ...docSnap.data() }));
      render();
    });

    // ===== ì¶”ê°€ ë²„íŠ¼ ë¡œì§ (ì‚¬ì§„ ë¡œì§ ì œê±°ë¨) =====
    addBtn.addEventListener("click", async () => {
      const title = titleInput.value.trim();
      if (!title) { showToast("ì‘í’ˆ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!", "error"); return; }

      const episodeTextRaw = episodeInput.value.trim();
      const { season, episodeNum } = parseEpisodeInput(episodeTextRaw);
      const episodeText = episodeTextRaw || buildEpisodeText(season, episodeNum);
      
      await addDoc(itemsCol, {
          title, episodeText, seen: seenInput.value, memo: memoInput.value.trim(),
          season: season ?? null, episodeNum: episodeNum ?? null, createdAt: Date.now()
      });

      showToast(`'${title}' ì¶”ê°€ ì™„ë£Œ!`);
      
      titleInput.value = ""; episodeInput.value = ""; memoInput.value = ""; seenInput.value = "W";
      titleInput.focus();
    });

    clearAllBtn.addEventListener("click", async () => {
      if (!confirm("âš ï¸ ê²½ê³ : ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì§„í–‰í• ê¹Œìš”?")) return;
      const snap = await getDocs(itemsCol);
      await Promise.all(snap.docs.map((d) => deleteDoc(d.ref)));
      showToast("ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
    });

    searchInput.addEventListener("input", (e) => { searchQuery = e.target.value.trim().toLowerCase(); render(); });
    sortSelect.addEventListener("change", (e) => { sortMode = e.target.value; render(); });
    statusFilter.addEventListener("change", (e) => { filterStatus = e.target.value; render(); });

    const MAX_SEASON = 20;
    const MAX_EPISODE = 200;

    // ===== ë Œë”ë§ í•¨ìˆ˜ (ì‚¬ì§„ ë¡œì§ ì œê±° ë° ë ˆì´ì•„ì›ƒ ë³µêµ¬) =====
    function render() {
      grid.innerHTML = "";
      let display = items.map((item) => ({ ...item, seenNorm: normalizeSeen(item) }));
      if (searchQuery) display = display.filter((item) => (item.title || "").toLowerCase().includes(searchQuery));
      if (filterStatus !== "ALL") display = display.filter((item) => item.seenNorm === filterStatus);
      display.sort((a, b) => sortMode === "titleAsc" ? (a.title || "").localeCompare(b.title || "", "ko") : getCreatedAtMs(b) - getCreatedAtMs(a));
      
      const countO = display.filter((i) => i.seenNorm === "O").length;
      const countW = display.filter((i) => i.seenNorm === "W").length;
      const countX = display.filter((i) => i.seenNorm === "X").length;
      statsSummary.innerHTML = `ì´ <b>${display.length}</b>ì‘í’ˆ (ì™„ë£Œ ${countO} Â· ì‹œì²­ì¤‘ ${countW} Â· ë¯¸ì‹œì²­ ${countX})`;
      emptyEl.style.display = display.length === 0 ? "block" : "none";

      display.forEach((item) => {
        const docRef = doc(db, "animeItems", item.id);
        const card = document.createElement("div"); card.className = "card";

        // --- Header ---
        const headerRow = document.createElement("div"); headerRow.className = "card-header-row";
        const titleGroup = document.createElement("div"); titleGroup.className = "card-title-group";
        const titleEl = document.createElement("div"); titleEl.className = "card-title"; titleEl.textContent = item.title;
        
        let epLabel = item.episodeText;
        const builtFromNumbers = buildEpisodeText(item.season, item.episodeNum);
        if ((!epLabel && builtFromNumbers) || (builtFromNumbers && epLabel !== builtFromNumbers)) epLabel = builtFromNumbers;
        if (!epLabel) epLabel = "íšŒì°¨ ì •ë³´ ì—†ìŒ";
        
        const subtitleEl = document.createElement("div"); subtitleEl.className = "card-subtitle"; subtitleEl.textContent = epLabel;
        titleGroup.appendChild(titleEl); titleGroup.appendChild(subtitleEl);
        
        const chip = document.createElement("div");
        chip.className = `status-chip ${item.seenNorm === 'O' ? 'done' : item.seenNorm === 'W' ? 'watching' : 'not'}`;
        chip.innerHTML = item.seenNorm === 'O' ? 'âœ… ì™„ë£Œ' : item.seenNorm === 'W' ? 'ğŸ‘€ ë³´ëŠ”ì¤‘' : 'âŒ ì•ˆë´„';
        headerRow.appendChild(titleGroup); headerRow.appendChild(chip);

        // --- Controls ---
        const controls = document.createElement("div"); controls.className = "card-controls";
        const statusGroup = document.createElement("div"); statusGroup.className = "control-group";
        statusGroup.innerHTML = `<span class="control-label">ìƒíƒœ</span>`;
        const statusSelect = document.createElement("select"); statusSelect.className = "wheel-select";
        statusSelect.innerHTML = `<option value="O" ${item.seenNorm==="O"?"selected":""}>ì™„ë£Œ</option><option value="W" ${item.seenNorm==="W"?"selected":""}>ë³´ëŠ”ì¤‘</option><option value="X" ${item.seenNorm==="X"?"selected":""}>ì•ˆë´„</option>`;
        statusSelect.addEventListener("change", async(e) => { await updateDoc(docRef, { seen: e.target.value }); showToast("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); });
        statusGroup.appendChild(statusSelect);

        const epGroup = document.createElement("div"); epGroup.className = "control-group";
        const seasonSelect = document.createElement("select"); seasonSelect.className = "wheel-select";
        seasonSelect.innerHTML = `<option value="-">ì‹œì¦Œ</option>` + Array.from({length:MAX_SEASON},(_,i)=>`<option value="${i+1}">${i+1}ê¸°</option>`).join('');
        seasonSelect.value = item.season ?? "-";
        const episodeSelect = document.createElement("select"); episodeSelect.className = "wheel-select";
        episodeSelect.innerHTML = `<option value="-">íšŒì°¨</option>` + Array.from({length:MAX_EPISODE},(_,i)=>`<option value="${i+1}">${i+1}í™”</option>`).join('');
        episodeSelect.value = item.episodeNum ?? "-";
        const updateEpInfo = async (newSeason, newEp) => {
            const newText = buildEpisodeText(newSeason, newEp);
            await updateDoc(docRef, { season: newSeason, episodeNum: newEp, episodeText: newText });
        }
        seasonSelect.addEventListener("change", (e) => updateEpInfo(e.target.value==='-'?null:Number(e.target.value), episodeSelect.value==='-'?null:Number(episodeSelect.value)));
        episodeSelect.addEventListener("change", (e) => updateEpInfo(seasonSelect.value==='-'?null:Number(seasonSelect.value), e.target.value==='-'?null:Number(e.target.value)));
        epGroup.appendChild(seasonSelect); epGroup.appendChild(episodeSelect);

        const plusOneBtn = document.createElement("button");
        plusOneBtn.className = "plus-one-btn"; plusOneBtn.textContent = "+1í™”";
        plusOneBtn.addEventListener("click", async () => {
            let currentEp = item.episodeNum ?? 0; let nextEp = currentEp + 1;
            await updateDoc(docRef, { episodeNum: nextEp, episodeText: buildEpisodeText(item.season, nextEp), seen: 'W' });
            showToast(`'${item.title}' ${nextEp}í™”ë¡œ ì—…ë°ì´íŠ¸!`, 'success');
        });
        epGroup.appendChild(plusOneBtn);
        controls.appendChild(statusGroup); controls.appendChild(epGroup);

        // --- Memo ---
        const memoEl = document.createElement("textarea"); memoEl.className = "memo"; memoEl.placeholder = "ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."; memoEl.value = item.memo || "";
        memoEl.addEventListener("change", async(e) => { await updateDoc(docRef, { memo: e.target.value.trim() }); showToast("ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); });

        // --- Footer ---
        const footer = document.createElement("div"); footer.className = "card-footer";
        footer.textContent = getCreatedAtMs(item) ? new Date(getCreatedAtMs(item)).toLocaleDateString() + " ì¶”ê°€ë¨" : "";
        const delBtn = document.createElement("button"); delBtn.className = "secondary danger small-btn";
        delBtn.innerHTML = `ğŸ—‘ï¸ ì‚­ì œ`;
        delBtn.addEventListener("click", async() => { if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await deleteDoc(docRef); showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "error"); }});
        footer.appendChild(delBtn);

        // êµ¬ì¡° ì¡°ë¦½
        card.appendChild(headerRow);
        card.appendChild(controls);
        card.appendChild(memoEl);
        card.appendChild(footer);
        grid.appendChild(card);
      });
    }
  </script>
</body>
</html>
