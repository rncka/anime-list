<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ì• ë‹ˆë¦¬ìŠ¤íŠ¸</title>
  
  <link rel="apple-touch-icon" href="icon_512.png" />
  <link rel="icon" type="image/png" href="icon_512.png" />

  <style>
    /* ë””ìì¸ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ì˜ˆì˜ê²Œ ìœ ì§€ */
    :root[data-theme="light"] {
      --bg-app: #f8fafc; --bg-surface: #ffffff; --bg-surface-alt: #f1f5f9;
      --text-primary: #1e293b; --text-secondary: #64748b;
      --border-color: #e2e8f0; --accent-color: #6366f1;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    }
    :root[data-theme="dark"] {
      --bg-app: #0f172a; --bg-surface: #1e293b; --bg-surface-alt: #334155;
      --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --border-color: #334155; --accent-color: #818cf8;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: "Pretendard", sans-serif; padding: 0; margin: 0;
      background-color: var(--bg-app); color: var(--text-primary);
      overflow-x: hidden; transition: 0.3s;
    }
    .app { max-width: 600px; margin: 0 auto; padding: 20px 20px 80px 20px; }

    /* í—¤ë” & ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    .sticky-header-container {
      position: sticky; top: 0; z-index: 100; background-color: var(--bg-app);
      padding: 10px 20px; margin: 0 -20px;
      transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
    }
    .sticky-header-container.scrolled { background-color: var(--bg-surface); box-shadow: var(--shadow-sm); }
    .sticky-header-container.nav-up { transform: translateY(-100%); }

    h1 { font-size: 22px; margin: 0 0 12px 0; font-weight: 800; color: var(--accent-color); }
    
    .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    input, select, button, textarea {
      font-size: 14px; padding: 10px; border-radius: 12px;
      border: 1px solid var(--border-color); background: var(--bg-surface); color: var(--text-primary); outline: none;
    }
    input { flex: 1; }
    button { background: var(--accent-color); color: white; border: none; font-weight: 600; cursor: pointer; }
    
    .file-label {
      padding: 10px 14px; background: var(--bg-surface-alt); border: 1px solid var(--border-color);
      border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 18px; min-width: 44px;
    }
    .file-preview-name { font-size: 12px; color: var(--text-secondary); margin-left: 8px; display: none; }

    /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .grid { display: flex; flex-direction: column; gap: 16px; margin-top: 16px; }
    .card {
      background: var(--bg-surface); border-radius: 16px; padding: 16px;
      box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
      display: flex; gap: 12px; align-items: flex-start;
    }
    .card-thumb {
      width: 70px; height: 100px; border-radius: 8px; object-fit: cover; flex-shrink: 0;
      background: var(--bg-surface-alt); border: 1px solid var(--border-color);
    }
    .card-content { flex: 1; display: flex; flex-direction: column; gap: 6px; min-width: 0; }
    .card-title { font-size: 16px; font-weight: 700; }
    .card-controls { display: flex; gap: 6px; margin-top: 4px; }
    .plus-one-btn { padding: 4px 8px !important; font-size: 11px !important; background: var(--bg-surface-alt); color: var(--accent-color); border: 1px solid var(--accent-color); }
    .del-btn { background: transparent; color: #ef4444; border: 1px solid #ef4444; padding: 4px 8px; font-size: 11px; border-radius: 6px; margin-left: auto; }

    /* ê¸°íƒ€ */
    .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--accent-color); border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 300px; pointer-events: none; }
    .toast { background: rgba(0,0,0,0.85); color: white; padding: 12px 16px; border-radius: 20px; font-size: 13px; text-align: center; }
  </style>
</head>
<body>

<div class="app">
  <div class="sticky-header-container">
    <h1>ì• ë‹ˆë¦¬ìŠ¤íŠ¸ (ë¬´ë£Œë²„ì „)</h1>
    
    <div class="input-row">
      <label for="fileInput" class="file-label">ğŸ“·</label>
      <input type="file" id="fileInput" accept="image/*" style="display: none;" />
      <span id="fileNameDisplay" class="file-preview-name"></span>
      <input id="titleInput" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
    </div>
    
    <div class="input-row">
      <input id="episodeInput" placeholder="1ê¸° 3í™”" style="flex:1;" />
      <select id="seenInput" style="flex:0.8;">
        <option value="W" selected>ë³´ëŠ”ì¤‘</option>
        <option value="O">ì™„ë£Œ</option>
        <option value="X">ì•ˆë´„</option>
      </select>
      <button id="addBtn" style="flex:0.8;">ì¶”ê°€</button>
    </div>
    
    <div style="font-size:12px; color:gray; text-align:right;" id="statsSummary"></div>
  </div>

  <section id="grid" class="grid"></section>
  <div id="empty" style="text-align:center; padding:40px; color:gray; display:none;">ì‘í’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>
</div>

<div id="toast-container"></div>

<script type="module">
  // â˜…â˜…â˜… Storage ê´€ë ¨ ì½”ë“œë¥¼ ë‹¤ ì‚­ì œí•˜ê³  Firestoreë§Œ ë‚¨ê²¼ìŠµë‹ˆë‹¤ â˜…â˜…â˜…
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyDpbP8aBRqOQtLNLDbtrly49ozPon4SQaWE",
      authDomain: "anime-list-85c9e.firebaseapp.com",
      projectId: "anime-list-85c9e",
      storageBucket: "anime-list-85c9e.firebasestorage.app",
      messagingSenderId: "397442929562",
      appId: "1:397442929562:web:1b5e3e90cbbfa8a573d8e51"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const itemsCol = collection(db, "animeItems");

  // DOM ìš”ì†Œ
  const addBtn = document.getElementById("addBtn");
  const fileInput = document.getElementById("fileInput");
  const fileNameDisplay = document.getElementById("fileNameDisplay");
  const grid = document.getElementById("grid");
  const header = document.querySelector(".sticky-header-container");

  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
  function showToast(msg) {
    const t = document.createElement("div"); t.className = "toast"; t.innerText = msg;
    document.getElementById("toast-container").appendChild(t);
    setTimeout(() => t.remove(), 2500);
  }

  // íŒŒì¼ëª… í‘œì‹œ
  fileInput.addEventListener("change", (e) => {
    if(e.target.files[0]) {
        fileNameDisplay.textContent = e.target.files[0].name;
        fileNameDisplay.style.display = "block";
    }
  });

  // â˜…â˜…â˜… í•µì‹¬: ì´ë¯¸ì§€ë¥¼ ì••ì¶•í•´ì„œ ê¸€ìë¡œ ë°”ê¾¸ëŠ” í•¨ìˆ˜ â˜…â˜…â˜…
  function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement("canvas");
                // ì¸ë„¤ì¼ìš©ìœ¼ë¡œ í¬ê¸°ë¥¼ ì¤„ì…ë‹ˆë‹¤ (ìµœëŒ€ 300px)
                const MAX_WIDTH = 300;
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;
                
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // ê²°ê³¼ë¬¼ì„ ê¸€ì(Base64)ë¡œ ë³€í™˜
                resolve(canvas.toDataURL("image/jpeg", 0.7)); 
            }
        }
    });
  }

  // ì¶”ê°€ ë²„íŠ¼ ë¡œì§
  addBtn.addEventListener("click", async () => {
    const title = document.getElementById("titleInput").value.trim();
    if (!title) return showToast("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”!");

    addBtn.disabled = true;
    addBtn.innerHTML = `<span class="loader"></span>ì²˜ë¦¬ì¤‘`;

    try {
        let imageUrl = "";
        
        // ì‚¬ì§„ì´ ìˆìœ¼ë©´ ì••ì¶•í•´ì„œ ê¸€ìë¡œ ë³€í™˜
        if (fileInput.files[0]) {
            imageUrl = await compressImage(fileInput.files[0]);
        }

        await addDoc(itemsCol, {
            title, 
            episodeText: document.getElementById("episodeInput").value.trim(), 
            seen: document.getElementById("seenInput").value, 
            memo: "",
            imageUrl: imageUrl, // ê¸€ìë¡œ ë³€í™˜ëœ ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— ì €ì¥ë¨
            createdAt: Date.now()
        });

        showToast("ì €ì¥ ì™„ë£Œ!");
        
        // ì´ˆê¸°í™”
        document.getElementById("titleInput").value = "";
        document.getElementById("episodeInput").value = "";
        fileInput.value = ""; 
        fileNameDisplay.style.display = "none";

    } catch (e) {
        console.error(e);
        showToast("ì˜¤ë¥˜ ë°œìƒ (ì‚¬ì§„ì´ ë„ˆë¬´ í´ ìˆ˜ë„ ìˆì–´ìš”)");
    } finally {
        addBtn.disabled = false;
        addBtn.innerText = "ì¶”ê°€";
    }
  });

  // ì‚­ì œ ë¡œì§
  window.deleteItem = async (id) => {
    if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    await deleteDoc(doc(db, "animeItems", id));
    showToast("ì‚­ì œë¨");
  };

  // +1 ê¸°ëŠ¥
  window.plusOne = async (id, text) => {
    let num = text.match(/\d+/g);
    if(num) {
        let lastNum = parseInt(num[num.length-1]);
        let newText = text.replace(lastNum, lastNum + 1);
        await updateDoc(doc(db, "animeItems", id), { episodeText: newText, seen: 'W' });
        showToast("+1í™” ì™„ë£Œ!");
    }
  };

  // ë Œë”ë§
  onSnapshot(query(itemsCol, orderBy("createdAt", "desc")), (snap) => {
    let items = []; snap.forEach(d => items.push({id: d.id, ...d.data()}));
    
    grid.innerHTML = "";
    document.getElementById("statsSummary").innerText = `ì´ ${items.length}ê°œ`;
    document.getElementById("empty").style.display = items.length ? "none" : "block";

    items.forEach(item => {
        const div = document.createElement("div"); div.className = "card";
        
        const imgHtml = item.imageUrl 
            ? `<img src="${item.imageUrl}" class="card-thumb">`
            : `<div class="card-thumb" style="display:flex;align-items:center;justify-content:center;color:#ccc;font-size:24px;">ğŸ“º</div>`;

        div.innerHTML = `
            ${imgHtml}
            <div class="card-content">
                <div style="display:flex; justify-content:space-between;">
                    <span class="card-title">${item.title}</span>
                    <span style="font-size:11px; font-weight:bold; color:${item.seen==='O'?'green':item.seen==='W'?'orange':'gray'}">
                        ${item.seen==='O'?'ì™„ë£Œ':item.seen==='W'?'ë³´ëŠ”ì¤‘':'ì•ˆë´„'}
                    </span>
                </div>
                <div style="font-size:12px; color:gray;">${item.episodeText || 'íšŒì°¨ ì •ë³´ ì—†ìŒ'}</div>
                
                <div class="card-controls">
                    <button class="plus-one-btn" onclick="plusOne('${item.id}', '${item.episodeText || ''}')">+1í™”</button>
                    <button class="del-btn" onclick="deleteItem('${item.id}')">ì‚­ì œ</button>
                </div>
            </div>
        `;
        grid.appendChild(div);
    });
  });

  // í—¤ë” ìŠ¤í¬ë¡¤ íš¨ê³¼
  let lastScroll = 0;
  window.addEventListener("scroll", () => {
    const current = window.scrollY;
    if(current > 10) header.classList.add("scrolled"); else header.classList.remove("scrolled");
    if(current > lastScroll && current > 50) header.classList.add("nav-up");
    else header.classList.remove("nav-up");
    lastScroll = current;
  });
</script>
</body>
</html>
