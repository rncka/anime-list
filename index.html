<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì• ë‹ˆ / ë§Œí™” ë¦¬ìŠ¤íŠ¸ (ì¸ë„¤ì¼ + Firebase ì‹¤ì‹œê°„)</title>
  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --accent: #38bdf8;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
      --watching: #facc15;
      --done: #22c55e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b, #020617);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 24px 12px;
    }

    .app {
      width: 100%;
      max-width: 1000px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
      padding: 18px;
      backdrop-filter: blur(12px);
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 20px;
    }

    .title-block p {
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.12);
      border: 1px solid rgba(56, 189, 248, 0.5);
      color: var(--accent);
      white-space: nowrap;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }

    .input-row,
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      width: 100%;
    }

    input, select, button {
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text);
      outline: none;
    }

    input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      border: none;
      color: white;
      padding-inline: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    button.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    button.danger {
      background: transparent;
      border: 1px solid rgba(248, 113, 113, 0.6);
      color: #fecaca;
    }

    button:hover { filter: brightness(1.05); }
    button:active { transform: translateY(1px); }

    .toolbar {
      margin-top: 2px;
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .toolbar label {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
    }

    .toolbar input { min-width: 140px; }
    .toolbar select { min-width: 120px; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .card {
      background: rgba(15, 23, 42, 0.97);
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 270px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.7);
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.9);
      border-color: rgba(56, 189, 248, 0.6);
    }

    .thumb-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 3 / 4;
      background: radial-gradient(circle at top, #1d2436, #020617);
      overflow: hidden;
    }

    .thumb {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .thumb-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      color: rgba(148, 163, 184, 0.5);
    }

    .status-chip {
      position: absolute;
      left: 8px;
      bottom: 8px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #020617;
      background: rgba(248, 250, 252, 0.94);
    }

    .status-chip.done { background: rgba(34, 197, 94, 0.95); color: #022c22; }
    .status-chip.watching { background: rgba(250, 204, 21, 0.95); color: #422006; }
    .status-chip.not { background: rgba(248, 113, 113, 0.95); color: #450a0a; }

    .card-body {
      padding: 8px 9px 9px;
      display: flex;
      flex-direction: column;
      flex: 1;
      gap: 6px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .card-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .status-select-row {
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .status-select-row select {
      flex: 1;
    }

    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
    }

    .memo {
      font-size: 12px;
      color: var(--text);
      margin-top: 4px;
      min-height: 32px;
    }

    .card-footer {
      margin-top: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .small-btn {
      font-size: 11px;
      padding: 3px 8px;
    }

    .empty {
      margin-top: 12px;
      padding: 14px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      border-radius: 10px;
      border: 1px dashed rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.8);
    }

    @media (max-width: 640px) {
      .app { padding: 14px; }
      .app-header { flex-direction: column; align-items: flex-start; }
      .grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="app-header">
      <div class="title-block">
        <h1>ì• ë‹ˆ / ë§Œí™” ë¦¬ìŠ¤íŠ¸</h1>
        <p>Firebase + ìë™ ì¸ë„¤ì¼ë¡œ ê´€ë¦¬í•˜ëŠ” ë‚˜ë§Œì˜ ë¦¬ìŠ¤íŠ¸</p>
      </div>
      <div class="badge">ì‹¤ì‹œê°„ ë™ê¸°í™” Â· ì¸ë„¤ì¼ ìë™ ê°€ì ¸ì˜¤ê¸°</div>
    </div>

    <div class="controls">
      <div class="input-row">
        <input id="title" placeholder="ì‘í’ˆ ì´ë¦„">
        <input id="episode" placeholder="í™” (ì˜ˆ: 12í™”)">
        <select id="seen">
          <option value="O">O Â· ë‹¤ ë´„</option>
          <option value="W">â–³ Â· ë³´ëŠ” ì¤‘</option>
          <option value="X">X Â· ì•ˆ ë´„</option>
        </select>
        <input id="type" placeholder="ë©”ëª¨ (ë§Œí™”/ì• ë‹ˆ/ê¸°íƒ€)">
        <button onclick="addItem()">+ ì¶”ê°€</button>
        <button class="danger" onclick="clearAll()">ì „ì²´ ì‚­ì œ</button>
      </div>

      <div class="toolbar">
        <div class="toolbar-group">
          <label for="search">ê²€ìƒ‰</label>
          <input id="search" placeholder="ì œëª© ê²€ìƒ‰">
        </div>
        <div class="toolbar-group">
          <label for="sort">ì •ë ¬</label>
          <select id="sort">
            <option value="createdDesc">ìµœê·¼ ì¶”ê°€ìˆœ</option>
            <option value="titleAsc">ì´ë¦„ìˆœ (ê°€ë‚˜ë‹¤)</option>
          </select>
        </div>
        <div class="toolbar-group">
          <label for="filter">ìƒíƒœ</label>
          <select id="filter">
            <option value="ALL">ì „ì²´</option>
            <option value="O">O Â· ë‹¤ ë´„</option>
            <option value="W">â–³ Â· ë³´ëŠ” ì¤‘</option>
            <option value="X">X Â· ì•ˆ ë´„</option>
          </select>
        </div>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì‘í’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
      doc,
      updateDoc,
      deleteDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    // ë„¤ Firebase í”„ë¡œì íŠ¸ ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyDpbP8aBRqOQtLNLDbtrly49ozPon4SQaWE",
      authDomain: "anime-list-85c9e.firebaseapp.com",
      projectId: "anime-list-85c9e",
      storageBucket: "anime-list-85c9e.firebasestorage.app",
      messagingSenderId: "397442929562",
      appId: "1:397442929562:web:1b5e3e90cbbfa8a573d8e51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const itemsCol = collection(db, "animeItems");

    let items = [];
    let sortMode = "createdDesc";
    let filterStatus = "ALL";
    let searchQuery = "";

    // ì œëª©ë³„ ì¸ë„¤ì¼ ìºì‹œ
    const IMAGE_CACHE = {};

    // Firestore ì‹¤ì‹œê°„ êµ¬ë…
    const q = query(itemsCol, orderBy("createdAt", "asc"));
    onSnapshot(q, (snapshot) => {
      items = [];
      snapshot.forEach((docSnap) => {
        items.push({ id: docSnap.id, ...docSnap.data() });
      });
      render();
    });

    // ì…ë ¥/í•„í„° ì´ë²¤íŠ¸ ì—°ê²°
    const searchInput = document.getElementById("search");
    const sortSelect = document.getElementById("sort");
    const filterSelect = document.getElementById("filter");

    searchInput.addEventListener("input", (e) => {
      searchQuery = e.target.value.trim().toLowerCase();
      render();
    });

    sortSelect.addEventListener("change", (e) => {
      sortMode = e.target.value;
      render();
    });

    filterSelect.addEventListener("change", (e) => {
      filterStatus = e.target.value;
      render();
    });

    // í•­ëª© ì¶”ê°€
    window.addItem = async function () {
      const title = document.getElementById("title").value.trim();
      const episode = document.getElementById("episode").value.trim();
      const seen = document.getElementById("seen").value;
      const type = document.getElementById("type").value.trim();

      if (!title) {
        alert("ì‘í’ˆ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }

      await addDoc(itemsCol, {
        title,
        episode,
        seen,
        type,
        createdAt: Date.now()
      });

      document.getElementById("title").value = "";
      document.getElementById("episode").value = "";
      document.getElementById("type").value = "";
    };

    // ìƒíƒœ ë³€ê²½
    window.toggleSeen = async function (id, value) {
      await updateDoc(doc(db, "animeItems", id), { seen: value });
    };

    // ì‚­ì œ
    window.deleteItem = async function (id) {
      if (!confirm("ì´ í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?")) return;
      await deleteDoc(doc(db, "animeItems", id));
    };

    // ì „ì²´ ì‚­ì œ
    window.clearAll = async function () {
      if (!confirm("ì •ë§ ì „ì²´ ì‚­ì œí• ê¹Œìš”?")) return;
      const snap = await getDocs(itemsCol);
      const tasks = snap.docs.map((d) => deleteDoc(d.ref));
      await Promise.all(tasks);
    };

    // createdAt ìˆ«ì/íƒ€ì„ìŠ¤íƒ¬í”„ ë‘˜ ë‹¤ ì§€ì›
    function getCreatedAtMs(item) {
      const v = item.createdAt;
      if (!v) return 0;
      if (typeof v === "number") return v;
      if (v.toMillis) return v.toMillis();
      return 0;
    }

    function normalizeSeen(item) {
      const v = (item.seen || "X").toUpperCase();
      if (v === "O" || v === "W" || v === "X") return v;
      return "X";
    }

    // ì¸ë„¤ì¼ ê°€ì ¸ì˜¤ê¸°
    async function fetchThumbnail(item) {
      const title = (item.title || "").trim();
      if (!title) return null;

      // ìºì‹œ ë¨¼ì € í™•ì¸
      if (IMAGE_CACHE[title]) return IMAGE_CACHE[title];

      // ë¬¸ì„œì— ì´ë¯¸ ì €ì¥ëœ ê²½ìš°
      if (item.imageUrl) {
        IMAGE_CACHE[title] = item.imageUrl;
        return item.imageUrl;
      }

      try {
        const url = `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(title)}&limit=1`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const img = data?.data?.[0]?.images?.jpg?.image_url;
        IMAGE_CACHE[title] = img || null;

        if (img) {
          // Firestoreì— ì €ì¥í•´ ë‘ë©´ ë‹¤ìŒì— ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
          try {
            await updateDoc(doc(db, "animeItems", item.id), { imageUrl: img });
          } catch (err) {
            // ê¶Œí•œ ë¬¸ì œ ë“±ì€ ë¬´ì‹œí•˜ê³  ë„˜ì–´ê°
          }
        }
        return img || null;
      } catch (e) {
        console.warn("ì¸ë„¤ì¼ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", title, e);
        IMAGE_CACHE[title] = null;
        return null;
      }
    }

    // ë Œë”ë§
    function render() {
      const grid = document.getElementById("grid");
      const emptyEl = document.getElementById("empty");
      grid.innerHTML = "";

      let display = items.map((item) => ({
        ...item,
        seen: normalizeSeen(item)
      }));

      if (searchQuery) {
        display = display.filter((item) =>
          (item.title || "").toLowerCase().includes(searchQuery)
        );
      }

      if (filterStatus !== "ALL") {
        display = display.filter((item) => normalizeSeen(item) === filterStatus);
      }

      display.sort((a, b) => {
        if (sortMode === "titleAsc") {
          return (a.title || "").localeCompare(b.title || "", "ko");
        } else {
          return getCreatedAtMs(b) - getCreatedAtMs(a);
        }
      });

      if (display.length === 0) {
        emptyEl.style.display = "block";
        return;
      } else {
        emptyEl.style.display = "none";
      }

      display.forEach((item) => {
        const status = normalizeSeen(item);

        const card = document.createElement("div");
        card.className = "card";

        const thumbWrapper = document.createElement("div");
        thumbWrapper.className = "thumb-wrapper";

        const img = document.createElement("img");
        img.className = "thumb";
        img.style.display = "none";

        const placeholder = document.createElement("div");
        placeholder.className = "thumb-placeholder";
        placeholder.textContent = "ğŸ¬";

        thumbWrapper.appendChild(img);
        thumbWrapper.appendChild(placeholder);

        const chip = document.createElement("div");
        chip.className = "status-chip";
        if (status === "O") chip.classList.add("done");
        else if (status === "W") chip.classList.add("watching");
        else chip.classList.add("not");

        chip.textContent =
          status === "O" ? "ë‹¤ ë´„" :
          status === "W" ? "ë³´ëŠ” ì¤‘" : "ì•ˆ ë´„";

        thumbWrapper.appendChild(chip);

        const body = document.createElement("div");
        body.className = "card-body";

        const titleEl = document.createElement("div");
        titleEl.className = "card-title";
        titleEl.textContent = item.title || "";

        const metaEl = document.createElement("div");
        metaEl.className = "card-meta";
        metaEl.textContent = item.episode ? `${item.episode}` : "í™” ì •ë³´ ì—†ìŒ";

        const statusRow = document.createElement("div");
        statusRow.className = "status-select-row";
        const pill = document.createElement("div");
        pill.className = "pill";
        pill.textContent = "ìƒíƒœ ë³€ê²½";

        const select = document.createElement("select");
        select.innerHTML = `
          <option value="O" ${status === "O" ? "selected" : ""}>O Â· ë‹¤ ë´„</option>
          <option value="W" ${status === "W" ? "selected" : ""}>â–³ Â· ë³´ëŠ” ì¤‘</option>
          <option value="X" ${status === "X" ? "selected" : ""}>X Â· ì•ˆ ë´„</option>
        `;
        select.onchange = (e) => toggleSeen(item.id, e.target.value);

        statusRow.appendChild(pill);
        statusRow.appendChild(select);

        const memo = document.createElement("div");
        memo.className = "memo";
        memo.textContent = item.type || "";

        const footer = document.createElement("div");
        footer.className = "card-footer";

        const timeEl = document.createElement("div");
        timeEl.className = "card-meta";
        const d = getCreatedAtMs(item);
        if (d) {
          const date = new Date(d);
          timeEl.textContent = date.toLocaleString("ko-KR");
        } else {
          timeEl.textContent = "";
        }

        const delBtn = document.createElement("button");
        delBtn.className = "secondary small-btn";
        delBtn.textContent = "ì‚­ì œ";
        delBtn.onclick = () => deleteItem(item.id);

        footer.appendChild(timeEl);
        footer.appendChild(delBtn);

        body.appendChild(titleEl);
        body.appendChild(metaEl);
        body.appendChild(statusRow);
        body.appendChild(memo);
        body.appendChild(footer);

        card.appendChild(thumbWrapper);
        card.appendChild(body);
        grid.appendChild(card);

        // ì¸ë„¤ì¼ ë¹„ë™ê¸° ë¡œë”©
        fetchThumbnail(item).then((url) => {
          if (url) {
            img.src = url;
            img.onload = () => {
              img.style.display = "block";
              placeholder.style.display = "none";
            };
          }
        });
      });
    }
  </script>
</body>
</html>
