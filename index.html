<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>애니리스트</title>

  <!-- iPhone / iPad 홈 화면 아이콘 -->
  <link rel="apple-touch-icon" href="icon_512.png" />
  <link rel="icon" type="image/png" href="icon_512.png" />

  <style>
    :root[data-theme="light"] {
      --bg: #f3f4f6;
      --text: #111827;
      --subtext: #4b5563;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --accent: #38bdf8;
      --danger: #f97373;
      --status-done: #d4f6d4;
      --status-watching: #fff4c4;
      --status-not: #ffd4d4;
      --chip-text: #111827;
    }

    :root[data-theme="dark"] {
      --bg: #020617;
      --text: #e5e7eb;
      --subtext: #9ca3af;
      --card-bg: #020617;
      --border: #1f2937;
      --accent: #38bdf8;
      --danger: #f97373;
      --status-done: #14532d;
      --status-watching: #78350f;
      --status-not: #7f1d1d;
      --chip-text: #f9fafb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    h1 {
      margin: 0 0 4px;
      font-size: 20px;
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .title-block p {
      margin: 0;
      font-size: 12px;
      color: var(--subtext);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--subtext);
    }

    .controls {
      margin-bottom: 12px;
    }

    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    input,
    select,
    button {
      font-size: 13px;
      padding: 5px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      outline: none;
    }

    input:focus,
    select:focus {
      border-color: var(--accent);
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: #f9fafb;
      padding-inline: 12px;
      font-weight: 500;
      white-space: nowrap;
    }

    button.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--subtext);
    }

    button.danger {
      background: #b91c1c;
    }

    button.small-btn {
      padding: 3px 8px;
      font-size: 11px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 10px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 4px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
    }

    .card-meta {
      font-size: 12px;
      color: var(--subtext);
    }

    .status-chip {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      color: var(--chip-text);
      white-space: nowrap;
    }

    .status-chip.done {
      background: var(--status-done);
    }

    .status-chip.watching {
      background: var(--status-watching);
    }

    .status-chip.not {
      background: var(--status-not);
    }

    .status-select-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .pill {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.2);
      font-size: 11px;
      color: var(--subtext);
    }

    .memo {
      font-size: 13px;
      min-height: 20px;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }

    .theme-select {
      font-size: 12px;
      padding: 4px 8px;
    }

    .empty {
      margin-top: 16px;
      font-size: 13px;
      color: var(--subtext);
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="app-header">
      <div class="title-block">
        <h1>애니리스트</h1>
        <p>Firebase로 동기화되는 나만의 시청 리스트</p>
      </div>
      <div class="header-actions">
        <select id="themeSelect" class="theme-select">
          <option value="light">라이트 모드</option>
          <option value="dark">다크 모드</option>
        </select>
        <button class="danger" onclick="clearAll()">전체 삭제</button>
      </div>
    </div>

    <div class="controls">
      <div class="input-row">
        <input id="title" placeholder="작품 이름" />
        <input id="episode" placeholder="화 (예: 12화)" />
        <select id="seen">
          <option value="O">O · 다 봄</option>
          <option value="W">△ · 보는 중</option>
          <option value="X">X · 안 봄</option>
        </select>
        <input id="type" placeholder="메모 (만화/애니/기타)" />
        <button onclick="addItem()">+ 추가</button>
      </div>

      <div class="input-row">
        <input id="search" placeholder="제목 검색" style="min-width: 130px" />
        <select id="sort">
          <option value="createdDesc">최근 추가순</option>
          <option value="titleAsc">이름순 (가나다)</option>
        </select>
        <select id="filter">
          <option value="ALL">전체</option>
          <option value="O">O · 다 봄</option>
          <option value="W">△ · 보는 중</option>
          <option value="X">X · 안 봄</option>
        </select>
        <span class="badge" id="countBadge"></span>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display: none;">
      데이터가 없습니다. 위에서 작품을 추가해주세요.
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
      doc,
      updateDoc,
      deleteDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyDpbP8aBRqOQtLNLDbtrly49ozPon4SQaWE",
      authDomain: "anime-list-85c9e.firebaseapp.com",
      projectId: "anime-list-85c9e",
      storageBucket: "anime-list-85c9e.firebasestorage.app",
      messagingSenderId: "397442929562",
      appId: "1:397442929562:web:1b5e3e90cbbfa8a573d8e51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const itemsCol = collection(db, "animeItems");

    let items = [];
    let sortMode = "createdDesc";
    let filterStatus = "ALL";
    let searchQuery = "";

    const titleInput = document.getElementById("title");
    const episodeInput = document.getElementById("episode");
    const seenInput = document.getElementById("seen");
    const typeInput = document.getElementById("type");
    const searchInput = document.getElementById("search");
    const sortSelect = document.getElementById("sort");
    const filterSelect = document.getElementById("filter");
    const themeSelect = document.getElementById("themeSelect");
    const countBadge = document.getElementById("countBadge");

    // --- 테마 관련 ---
    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("animeListTheme", theme);
    }

    // 초기 테마 적용
    const savedTheme = localStorage.getItem("animeListTheme") || "dark";
    setTheme(savedTheme);
    themeSelect.value = savedTheme;

    themeSelect.addEventListener("change", (e) => {
      setTheme(e.target.value);
    });

    // Firestore 실시간 구독
    const q = query(itemsCol, orderBy("createdAt", "asc"));
    onSnapshot(q, (snapshot) => {
      items = [];
      snapshot.forEach((docSnap) => {
        items.push({ id: docSnap.id, ...docSnap.data() });
      });
      render();
    });

    // 검색/정렬/필터 이벤트
    searchInput.addEventListener("input", (e) => {
      searchQuery = e.target.value.toLowerCase();
      render();
    });

    sortSelect.addEventListener("change", (e) => {
      sortMode = e.target.value;
      render();
    });

    filterSelect.addEventListener("change", (e) => {
      filterStatus = e.target.value;
      render();
    });

    // 항목 추가
    window.addItem = async function () {
      const title = titleInput.value.trim();
      const episode = episodeInput.value.trim();
      const seen = seenInput.value;
      const type = typeInput.value.trim();

      if (!title) {
        alert("작품 이름을 입력해주세요!");
        return;
      }

      await addDoc(itemsCol, {
        title,
        episode,
        seen,
        type,
        createdAt: Date.now()
      });

      titleInput.value = "";
      episodeInput.value = "";
      typeInput.value = "";
    };

    // 상태 변경
    window.toggleSeen = async function (id, value) {
      await updateDoc(doc(db, "animeItems", id), { seen: value });
    };

    // 삭제
    window.deleteItem = async function (id) {
      if (!confirm("이 항목을 삭제할까요?")) return;
      await deleteDoc(doc(db, "animeItems", id));
    };

    // 전체 삭제
    window.clearAll = async function () {
      if (!confirm("정말 전체 삭제할까요?")) return;
      const snap = await getDocs(itemsCol);
      const tasks = snap.docs.map((d) => deleteDoc(d.ref));
      await Promise.all(tasks);
    };

    function getCreatedAtMs(item) {
      const v = item.createdAt;
      if (!v) return 0;
      if (typeof v === "number") return v;
      if (v.toMillis) return v.toMillis();
      return 0;
    }

    function normalizeSeen(item) {
      const v = (item.seen || "X").toUpperCase();
      if (v === "O" || v === "W" || v === "X") return v;
      return "X";
    }

    function render() {
      const grid = document.getElementById("grid");
      const emptyEl = document.getElementById("empty");
      grid.innerHTML = "";

      let arr = items.map((item) => ({
        ...item,
        seen: normalizeSeen(item)
      }));

      // 카운트 뱃지
      const total = arr.length;
      const doneCount = arr.filter((i) => i.seen === "O").length;
      const watchingCount = arr.filter((i) => i.seen === "W").length;
      const notCount = arr.filter((i) => i.seen === "X").length;
      countBadge.textContent =
        `전체 ${total} · O ${doneCount} · △ ${watchingCount} · X ${notCount}`;

      // 검색
      if (searchQuery) {
        arr = arr.filter((i) =>
          (i.title || "").toLowerCase().includes(searchQuery)
        );
      }

      // 상태 필터
      if (filterStatus !== "ALL") {
        arr = arr.filter((i) => i.seen === filterStatus);
      }

      // 정렬
      arr.sort((a, b) => {
        if (sortMode === "titleAsc") {
          return (a.title || "").localeCompare(b.title || "", "ko");
        }
        // 최근 추가순 (createdAt 내림차순)
        return getCreatedAtMs(b) - getCreatedAtMs(a);
      });

      if (arr.length === 0) {
        emptyEl.style.display = "block";
        return;
      } else {
        emptyEl.style.display = "none";
      }

      arr.forEach((item) => {
        const card = document.createElement("div");
        card.className = "card";

        const header = document.createElement("div");
        header.className = "card-header";

        const titleBox = document.createElement("div");
        const titleEl = document.createElement("div");
        titleEl.className = "card-title";
        titleEl.textContent = item.title || "";

        const metaEl = document.createElement("div");
        metaEl.className = "card-meta";
        metaEl.textContent = item.episode || "화 정보 없음";

        titleBox.appendChild(titleEl);
        titleBox.appendChild(metaEl);

        const chip = document.createElement("div");
        chip.className = "status-chip";
        if (item.seen === "O") chip.classList.add("done");
        else if (item.seen === "W") chip.classList.add("watching");
        else chip.classList.add("not");

        chip.textContent =
          item.seen === "O"
            ? "다 봄"
            : item.seen === "W"
            ? "보는 중"
            : "안 봄";

        header.appendChild(titleBox);
        header.appendChild(chip);

        const statusRow = document.createElement("div");
        statusRow.className = "status-select-row";

        const pill = document.createElement("div");
        pill.className = "pill";
        pill.textContent = "상태";

        const select = document.createElement("select");
        select.innerHTML = `
          <option value="O" ${item.seen === "O" ? "selected" : ""}>O · 다 봄</option>
          <option value="W" ${item.seen === "W" ? "selected" : ""}>△ · 보는 중</option>
          <option value="X" ${item.seen === "X" ? "selected" : ""}>X · 안 봄</option>
        `;
        select.onchange = (e) => toggleSeen(item.id, e.target.value);

        statusRow.appendChild(pill);
        statusRow.appendChild(select);

        const memo = document.createElement("div");
        memo.className = "memo";
        memo.textContent = item.type || "";

        const footer = document.createElement("div");
        footer.className = "card-footer";

        const timeEl = document.createElement("div");
        timeEl.className = "card-meta";
        const t = getCreatedAtMs(item);
        if (t) {
          timeEl.textContent = new Date(t).toLocaleString("ko-KR");
        } else {
          timeEl.textContent = "";
        }

        const delBtn = document.createElement("button");
        delBtn.className = "secondary small-btn";
        delBtn.textContent = "삭제";
        delBtn.onclick = () => deleteItem(item.id);

        footer.appendChild(timeEl);
        footer.appendChild(delBtn);

        card.appendChild(header);
        card.appendChild(statusRow);
        card.appendChild(memo);
        card.appendChild(footer);

        grid.appendChild(card);
      });
    }
  </script>
</body>
</html>
