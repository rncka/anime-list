<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ë‚´ ì†ì•ˆì˜ ì• ë‹ˆë¦¬ìŠ¤íŠ¸</title>

  <link rel="apple-touch-icon" href="icon_512.png" />
  <link rel="icon" type="image/png" href="icon_512.png" />

  <style>
    /* ===== 1. ë””ìì¸ ë³€ìˆ˜ ì„ ì–¸ (ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ) ===== */
    :root[data-theme="light"] {
      --bg-app: #f8fafc; /* ë” ë°ê³  ê¹¨ë—í•œ ë°°ê²½ */
      --bg-surface: #ffffff;
      --bg-surface-alt: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --accent-color: #6366f1; /* ì¸ë””ê³  ê³„ì—´ ì—‘ì„¼íŠ¸ */
      --accent-hover: #4f46e5;
      --danger-color: #ef4444;
      --success-bg: #dcfce7; --success-text: #166534;
      --warning-bg: #fef9c3; --warning-text: #854d0e;
      --error-bg: #fee2e2;   --error-text: #991b1b;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    :root[data-theme="dark"] {
      --bg-app: #0f172a; /* ê¹Šì€ ë„¤ì´ë¹„ ë°°ê²½ */
      --bg-surface: #1e293b;
      --bg-surface-alt: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #334155;
      --accent-color: #818cf8;
      --accent-hover: #a5b4fc;
      --danger-color: #f87171;
      --success-bg: #052e16; --success-text: #4ade80;
      --warning-bg: #422006; --warning-text: #fde047;
      --error-bg: #450a0a;   --error-text: #f87171;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.4);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5), 0 4px 6px -4px rgb(0 0 0 / 0.5);
    }

    /* ===== 2. ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë¦¬ì…‹ ===== */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
      padding: 0; margin: 0;
      background-color: var(--bg-app);
      color: var(--text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
      overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    }
    .app { max-width: 800px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }

    /* ===== 3. ìƒë‹¨ ê³ ì • í—¤ë” & ì»¨íŠ¸ë¡¤ ì˜ì—­ (Sticky Header) ===== */
    .sticky-header-container {
      position: sticky;
      top: 0;
      z-index: 100;
      background-color: var(--bg-app); /* ë°°ê²½ìƒ‰ì„ ì§€ì •í•´ì•¼ ë’¤ê°€ ì•ˆ ë¹„ì¹¨ */
      padding-top: 20px;
      padding-bottom: 10px;
      margin-left: -20px; margin-right: -20px; padding-left: 20px; padding-right: 20px; /* ì „ì²´ ë„ˆë¹„ ì ìš© */
      border-bottom: 1px solid transparent;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    /* ìŠ¤í¬ë¡¤ ì‹œ í—¤ë”ì— ê·¸ë¦¼ì ì¶”ê°€ë¥¼ ìœ„í•œ í´ë˜ìŠ¤ (JSë¡œ ì œì–´) */
    .sticky-header-container.scrolled {
        border-bottom-color: var(--border-color);
        box-shadow: var(--shadow-sm);
        background-color: var(--bg-surface); /* ìŠ¤í¬ë¡¤ ì‹œ ì•½ê°„ ë°ê²Œ */
    }

    .app-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 16px;
    }
    h1 { margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.02em; background: linear-gradient(135deg, var(--accent-color), var(--accent-hover)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header-actions { display: flex; gap: 8px; }

    /* ì…ë ¥ì°½ ë° ë„êµ¬ ëª¨ìŒ ìŠ¤íƒ€ì¼ */
    .input-row { display: flex; gap: 8px; margin-bottom: 12px; }
    .input-row input { flex: 1; } /* ì œëª© ì…ë ¥ì°½ì´ ë‚¨ì€ ê³µê°„ ì°¨ì§€ */

    /* ê³µí†µ ì…ë ¥ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
    input, select, button, textarea {
      font-family: inherit; font-size: 14px; padding: 10px 14px;
      border-radius: 12px; border: 1px solid var(--border-color);
      background: var(--bg-surface); color: var(--text-primary);
      outline: none; transition: all 0.2s ease;
    }
    input::placeholder, textarea::placeholder { color: var(--text-secondary); opacity: 0.7; }
    input:focus, select:focus, textarea:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    button {
      cursor: pointer; font-weight: 600; border: none;
      background: var(--accent-color); color: white;
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    }
    button:hover { background: var(--accent-hover); transform: translateY(-1px); }
    button:active { transform: translateY(0); }

    button.secondary { background: var(--bg-surface-alt); color: var(--text-secondary); border: 1px solid var(--border-color); }
    button.secondary:hover { background: var(--border-color); color: var(--text-primary); }
    button.danger { background: #fee2e2; color: var(--danger-color); border: 1px solid #fecaca; }
    button.danger:hover { background: var(--danger-color); color: white; border-color: var(--danger-color); }
    button.icon-btn { padding: 8px; border-radius: 50%; aspect-ratio: 1; } /* ì•„ì´ì½˜ ë²„íŠ¼ */
    
    /* +1 ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .plus-one-btn {
        padding: 6px 10px !important;
        font-size: 12px !important;
        background: var(--bg-surface-alt) !important;
        color: var(--accent-color) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 8px !important;
        font-weight: 700 !important;
    }
    .plus-one-btn:hover {
        background: var(--accent-color) !important;
        color: white !important;
        border-color: var(--accent-color) !important;
    }


    .toolbar { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between; background: var(--bg-surface-alt); padding: 12px; border-radius: 16px; }
    .toolbar-group { display: flex; align-items: center; gap: 8px; flex: 1; }
    .toolbar-group label { font-size: 12px; font-weight: 600; color: var(--text-secondary); white-space: nowrap; }
    .toolbar-group input, .toolbar-group select { padding: 8px 12px; font-size: 13px; }
    .stats { font-size: 13px; font-weight: 500; color: var(--text-secondary); white-space: nowrap; margin-left: auto; }

    /* ===== 4. ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ (ë””ìì¸ ê°œì„ ) ===== */
    .grid { display: flex; flex-direction: column; gap: 16px; margin-top: 20px; }
    
    /* ì¹´ë“œ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .card {
      background: var(--bg-surface);
      border-radius: 20px;
      padding: 20px;
      box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
      animation: slideUpFade 0.3s ease-out forwards;
      display: flex; flex-direction: column; gap: 16px; /* Flex Column ê¸°ë°˜ */
      transition: all 0.2s ease;
    }
    .card:hover { box-shadow: var(--shadow-md); border-color: var(--accent-color); transform: translateY(-2px); }

    /* ì¹´ë“œ ìƒë‹¨: ì œëª©, ìƒíƒœ ì¹© */
    .card-header-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
    .card-title-group { flex: 1; }
    .card-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; line-height: 1.3; }
    .card-subtitle { font-size: 13px; color: var(--text-secondary); }

    /* ìƒíƒœ ì¹© ë””ìì¸ */
    .status-chip { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
    .status-chip.done { background: var(--success-bg); color: var(--success-text); }
    .status-chip.watching { background: var(--warning-bg); color: var(--warning-text); }
    .status-chip.not { background: var(--error-bg); color: var(--error-text); }

    /* ì¹´ë“œ ì¤‘ë‹¨: ì»¨íŠ¸ë¡¤ (ìƒíƒœ, ì‹œì¦Œ, íšŒì°¨) */
    .card-controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; padding: 12px; background: var(--bg-surface-alt); border-radius: 12px; }
    .control-group { display: flex; align-items: center; gap: 6px; }
    .control-label { font-size: 12px; color: var(--text-secondary); font-weight: 600; }
    .wheel-select { padding: 6px 10px; font-size: 13px; border-radius: 8px; background: var(--bg-surface); cursor: pointer; }

    /* ì¹´ë“œ ë©”ëª¨ */
    .memo { width: 100%; resize: vertical; min-height: 60px; border-radius: 12px; font-size: 13px; background: var(--bg-surface-alt); border: none; }
    .memo:focus { background: var(--bg-surface); border: 1px solid var(--accent-color); }

    /* ì¹´ë“œ í•˜ë‹¨: ë‚ ì§œ, ì‚­ì œ ë²„íŠ¼ */
    .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; font-size: 12px; color: var(--text-secondary); }
    
    /* ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ */
    .empty { text-align: center; padding: 40px; color: var(--text-secondary); font-size: 15px; background: var(--bg-surface-alt); border-radius: 20px; border: 2px dashed var(--border-color); }

    /* ===== 5. ê¸°íƒ€ UI ìš”ì†Œ (ìŠ¤í¬ë¡¤ ë²„íŠ¼, í† ìŠ¤íŠ¸ ì•Œë¦¼) ===== */
    .scroll-buttons { position: fixed; right: 20px; bottom: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 50; }
    .scroll-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--bg-surface); color: var(--text-primary); border: 1px solid var(--border-color); box-shadow: var(--shadow-md); font-size: 18px; padding: 0; }
    .scroll-btn:hover { background: var(--accent-color); color: white; border-color: transparent; }

    /* í† ìŠ¤íŠ¸ ì•Œë¦¼ì°½ ìŠ¤íƒ€ì¼ */
    #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
    .toast { background: var(--bg-surface); color: var(--text-primary); padding: 14px 20px; border-radius: 16px; box-shadow: var(--shadow-lg); font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 10px; animation: toastSlideUp 0.3s ease-out forwards; border: 1px solid var(--border-color); pointer-events: auto;}
    .toast.success { border-left: 4px solid var(--success-text); }
    .toast.error { border-left: 4px solid var(--error-text); }
    @keyframes toastSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastFadeOut { to { opacity: 0; transform: translateY(-20px); } }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 640px) {
      .app { padding: 16px; }
      .sticky-header-container { margin-left: -16px; margin-right: -16px; padding-left: 16px; padding-right: 16px;}
      .input-row { flex-direction: column; }
      .input-row input, .input-row select, .input-row button { width: 100%; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .stats { margin-left: 0; text-align: center; margin-top: 8px; }
      .card-controls { flex-direction: column; align-items: stretch; }
      .control-group { justify-content: space-between; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sticky-header-container">
        <header class="app-header">
        <h1>ë‚´ ì• ë‹ˆë¦¬ìŠ¤íŠ¸</h1>
        <div class="header-actions">
            <select id="themeSelect">
            <option value="system">ìë™ í…Œë§ˆ</option>
            <option value="light">â˜€ï¸ ë¼ì´íŠ¸</option>
            <option value="dark">ğŸŒ™ ë‹¤í¬</option>
            </select>
            <button id="clearAllBtn" class="secondary danger small-btn">ì „ì²´ ì‚­ì œ</button>
        </div>
        </header>

        <section class="controls">
        <div class="input-row">
            <input id="titleInput" placeholder="ì‘í’ˆ ì œëª© (ì˜ˆ: ìµœì• ì˜ ì•„ì´)" />
            <input id="episodeInput" placeholder="íšŒì°¨ (ì˜ˆ: 1ê¸° 3í™”)" style="flex: 0.6;" /> <select id="seenInput" style="flex: 0.5;">
            <option value="O">âœ… ë‹¤ ë´„</option>
            <option value="W" selected>ğŸ‘€ ë³´ëŠ” ì¤‘</option>
            <option value="X">âŒ ì•ˆ ë´„</option>
            </select>
        </div>
        <div class="input-row">
            <textarea id="memoInput" rows="1" placeholder="ì§§ì€ ë©”ëª¨..."></textarea>
            <button id="addBtn" style="flex: 0.4;">+ ì¶”ê°€í•˜ê¸°</button>
        </div>

        <div class="toolbar">
            <div class="toolbar-group" style="flex: 2;"> <input id="searchInput" placeholder="ğŸ” ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..." style="width: 100%;" />
            </div>
            <div class="toolbar-group">
            <select id="sortSelect">
                <option value="createdDesc">ğŸ“… ìµœì‹ ìˆœ</option>
                <option value="titleAsc">ğŸ”¤ ì´ë¦„ìˆœ</option>
            </select>
            <select id="statusFilter">
                <option value="ALL">ì „ì²´ ìƒíƒœ</option>
                <option value="O">âœ… ì™„ë£Œ</option>
                <option value="W">ğŸ‘€ ë³´ëŠ” ì¤‘</option>
                <option value="X">âŒ ë¯¸ì‹œì²­</option>
            </select>
            </div>
            <div class="stats" id="statsSummary"></div>
        </div>
        </section>
    </div> <section id="grid" class="grid"></section>
    <div id="empty" class="empty" style="display:none;">
        ğŸ“º ì•„ì§ ì¶”ê°€ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì—ì„œ ìƒˆë¡œìš´ ì• ë‹ˆë©”ì´ì…˜ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!
    </div>
  </div>

  <div class="scroll-buttons">
    <button id="scrollTopBtn" class="scroll-btn">â†‘</button>
    <button id="scrollBottomBtn" class="scroll-btn">â†“</button>
  </div>

  <div id="toast-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    // ===== Firebase ì„¤ì • (ë³¸ì¸ ê²ƒìœ¼ë¡œ ìœ ì§€) =====
    const firebaseConfig = {
      apiKey: "AIzaSyDpbP8aBRqOQtLNLDbtrly49ozPon4SQaWE",
      authDomain: "anime-list-85c9e.firebaseapp.com",
      projectId: "anime-list-85c9e",
      storageBucket: "anime-list-85c9e.firebasestorage.app",
      messagingSenderId: "397442929562",
      appId: "1:397442929562:web:1b5e3e90cbbfa8a573d8e51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const itemsCol = collection(db, "animeItems");

    // ===== ìƒíƒœ =====
    let items = [];
    let sortMode = "createdDesc";
    let filterStatus = "ALL";
    let searchQuery = "";

    // ===== DOM =====
    const themeSelect = document.getElementById("themeSelect");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const addBtn = document.getElementById("addBtn");
    const titleInput = document.getElementById("titleInput");
    const episodeInput = document.getElementById("episodeInput");
    const seenInput = document.getElementById("seenInput");
    const memoInput = document.getElementById("memoInput");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const statusFilter = document.getElementById("statusFilter");
    const grid = document.getElementById("grid");
    const emptyEl = document.getElementById("empty");
    const statsSummary = document.getElementById("statsSummary");
    const scrollTopBtn = document.getElementById("scrollTopBtn");
    const scrollBottomBtn = document.getElementById("scrollBottomBtn");
    const stickyHeader = document.querySelector('.sticky-header-container');
    const toastContainer = document.getElementById('toast-container');


    // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ (ìƒˆë¡œ ì¶”ê°€ë¨) =====
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        // íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ ì¶”ê°€
        const icon = type === 'success' ? 'âœ…' : 'âš ï¸';
        toast.innerHTML = `<span>${icon}</span> ${message}`;
        
        toastContainer.appendChild(toast);

        // 3ì´ˆ í›„ ì œê±° ì• ë‹ˆë©”ì´ì…˜ ë° ì‚­ì œ
        setTimeout(() => {
            toast.style.animation = 'toastFadeOut 0.3s ease-out forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ===== ìŠ¤í¬ë¡¤ ê°ì§€í•˜ì—¬ í—¤ë” ìŠ¤íƒ€ì¼ ë³€ê²½ (ìƒˆë¡œ ì¶”ê°€ë¨) =====
    window.addEventListener('scroll', () => {
        if (window.scrollY > 10) {
            stickyHeader.classList.add('scrolled');
        } else {
            stickyHeader.classList.remove('scrolled');
        }
    });


    // ===== í…Œë§ˆ ì²˜ë¦¬ =====
    function applyTheme(mode) {
      const root = document.documentElement;
      if (mode === "system") {
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        root.setAttribute("data-theme", prefersDark ? "dark" : "light");
      } else {
        root.setAttribute("data-theme", mode);
      }
      localStorage.setItem("animeListTheme", mode);
    }
    const storedTheme = localStorage.getItem("animeListTheme") || "system";
    themeSelect.value = storedTheme;
    applyTheme(storedTheme);
    themeSelect.addEventListener("change", (e) => applyTheme(e.target.value));

    // ===== ìŠ¤í¬ë¡¤ ë²„íŠ¼ =====
    scrollTopBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
    scrollBottomBtn.addEventListener("click", () => window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" }));

    // ===== ë°ì´í„° íŒŒì‹± ìœ í‹¸ =====
    function getCreatedAtMs(item) {
      const v = item.createdAt;
      if (!v) return 0;
      if (typeof v === "number") return v;
      if (v.toMillis) return v.toMillis();
      return 0;
    }
    function normalizeSeen(item) {
      const v = (item.seen || "X").toUpperCase();
      return ["O", "W", "X"].includes(v) ? v : "X";
    }
    function buildEpisodeText(season, episodeNum) {
      if (!season && !episodeNum) return "";
      const sPart = season ? `${season}ê¸°` : "";
      const ePart = episodeNum ? `${episodeNum}í™”` : "";
      return [sPart, ePart].filter(Boolean).join(" ");
    }
    function parseEpisodeInput(text) {
      if (!text) return { season: null, episodeNum: null };
      const cleaned = text.replace(/\s+/g, "").trim();
      let match = cleaned.match(/(\d+)\s*ê¸°\s*(\d+)\s*í™”?/);
      if (match) return { season: Number(match[1]), episodeNum: Number(match[2]) };
      match = cleaned.match(/(\d+)\s*ê¸°/);
      if (match) return { season: Number(match[1]), episodeNum: null };
      match = cleaned.match(/(\d+)\s*í™”/);
      if (match) return { season: null, episodeNum: Number(match[1]) };
      match = cleaned.match(/^(\d+)$/);
      if (match) return { season: null, episodeNum: Number(match[1]) };
      return { season: null, episodeNum: null };
    }

    // ===== Firestore êµ¬ë… =====
    onSnapshot(query(itemsCol, orderBy("createdAt", "asc")), (snapshot) => {
      items = [];
      snapshot.forEach((docSnap) => items.push({ id: docSnap.id, ...docSnap.data() }));
      render();
    });

    // ===== ì…ë ¥ ì´ë²¤íŠ¸ =====
    addBtn.addEventListener("click", async () => {
      const title = titleInput.value.trim();
      if (!title) { showToast("ì‘í’ˆ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!", "error"); return; } // alert ëŒ€ì‹  toast ì‚¬ìš©

      const episodeTextRaw = episodeInput.value.trim();
      const { season, episodeNum } = parseEpisodeInput(episodeTextRaw);
      const episodeText = episodeTextRaw || buildEpisodeText(season, episodeNum);

      await addDoc(itemsCol, {
        title, episodeText, seen: seenInput.value, memo: memoInput.value.trim(),
        season: season ?? null, episodeNum: episodeNum ?? null, createdAt: Date.now()
      });
      
      showToast(`'${title}' ì¶”ê°€ ì™„ë£Œ!`); // ì„±ê³µ í† ìŠ¤íŠ¸ ì•Œë¦¼

      titleInput.value = ""; episodeInput.value = ""; memoInput.value = ""; seenInput.value = "W"; // ê¸°ë³¸ê°’ì„ 'ë³´ëŠ”ì¤‘'ìœ¼ë¡œ ë³€ê²½
      titleInput.focus(); // ì…ë ¥ í›„ ë‹¤ì‹œ ì œëª©ì°½ì— í¬ì»¤ìŠ¤
    });

    clearAllBtn.addEventListener("click", async () => {
      if (!confirm("âš ï¸ ê²½ê³ : ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì§„í–‰í• ê¹Œìš”?")) return;
      const snap = await getDocs(itemsCol);
      await Promise.all(snap.docs.map((d) => deleteDoc(d.ref)));
      showToast("ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
    });

    searchInput.addEventListener("input", (e) => { searchQuery = e.target.value.trim().toLowerCase(); render(); });
    sortSelect.addEventListener("change", (e) => { sortMode = e.target.value; render(); });
    statusFilter.addEventListener("change", (e) => { filterStatus = e.target.value; render(); });

    // ===== ë Œë”ë§ (ë””ìì¸ ëŒ€í­ ìˆ˜ì •ë¨) =====
    const MAX_SEASON = 20; // ì‹œì¦Œ ìµœëŒ€ê°’ ì¦ê°€
    const MAX_EPISODE = 200; // íšŒì°¨ ìµœëŒ€ê°’ ì¦ê°€

    function render() {
      grid.innerHTML = "";
      let display = items.map((item) => ({ ...item, seenNorm: normalizeSeen(item) }));

      if (searchQuery) display = display.filter((item) => (item.title || "").toLowerCase().includes(searchQuery));
      if (filterStatus !== "ALL") display = display.filter((item) => item.seenNorm === filterStatus);

      display.sort((a, b) => sortMode === "titleAsc" ? (a.title || "").localeCompare(b.title || "", "ko") : getCreatedAtMs(b) - getCreatedAtMs(a));

      const countO = display.filter((i) => i.seenNorm === "O").length;
      const countW = display.filter((i) => i.seenNorm === "W").length;
      const countX = display.filter((i) => i.seenNorm === "X").length;
      statsSummary.innerHTML = `ì´ <b>${display.length}</b>ì‘í’ˆ (ì™„ë£Œ ${countO} Â· ì‹œì²­ì¤‘ ${countW} Â· ë¯¸ì‹œì²­ ${countX})`;

      emptyEl.style.display = display.length === 0 ? "block" : "none";

      display.forEach((item) => {
        const docRef = doc(db, "animeItems", item.id);
        const card = document.createElement("div"); card.className = "card";

        // --- ìƒë‹¨: ì œëª© ë° ìƒíƒœ ---
        const headerRow = document.createElement("div"); headerRow.className = "card-header-row";
        
        const titleGroup = document.createElement("div"); titleGroup.className = "card-title-group";
        const titleEl = document.createElement("div"); titleEl.className = "card-title"; titleEl.textContent = item.title;
        
        // íšŒì°¨ ì •ë³´ í‘œì‹œ ìµœì í™”
        let epLabel = item.episodeText;
        const builtFromNumbers = buildEpisodeText(item.season, item.episodeNum);
        // ì…ë ¥í•œ í…ìŠ¤íŠ¸ê°€ ì—†ê³  ìˆ«ì ì •ë³´ë§Œ ìˆì„ ë•Œ, ë˜ëŠ” ì…ë ¥ í…ìŠ¤íŠ¸ì™€ ìˆ«ì ì •ë³´ê°€ ë‹¤ë¥¼ ë•Œ ìˆ«ì ì •ë³´ ìš°ì„  í‘œì‹œ
        if ((!epLabel && builtFromNumbers) || (builtFromNumbers && epLabel !== builtFromNumbers)) {
             epLabel = builtFromNumbers;
        }
        if (!epLabel) epLabel = "íšŒì°¨ ì •ë³´ ì—†ìŒ";

        const subtitleEl = document.createElement("div"); subtitleEl.className = "card-subtitle"; subtitleEl.textContent = epLabel;
        titleGroup.appendChild(titleEl); titleGroup.appendChild(subtitleEl);

        const chip = document.createElement("div");
        chip.className = `status-chip ${item.seenNorm === 'O' ? 'done' : item.seenNorm === 'W' ? 'watching' : 'not'}`;
        chip.innerHTML = item.seenNorm === 'O' ? 'âœ… ì™„ë£Œ' : item.seenNorm === 'W' ? 'ğŸ‘€ ë³´ëŠ”ì¤‘' : 'âŒ ì•ˆë´„';
        
        headerRow.appendChild(titleGroup);
        headerRow.appendChild(chip);

        // --- ì¤‘ë‹¨: ì»¨íŠ¸ë¡¤ (ìƒíƒœ, ì‹œì¦Œ, íšŒì°¨) ---
        const controls = document.createElement("div"); controls.className = "card-controls";
        
        // ìƒíƒœ ì„ íƒ
        const statusGroup = document.createElement("div"); statusGroup.className = "control-group";
        statusGroup.innerHTML = `<span class="control-label">ìƒíƒœ</span>`;
        const statusSelect = document.createElement("select"); statusSelect.className = "wheel-select";
        statusSelect.innerHTML = `<option value="O" ${item.seenNorm==="O"?"selected":""}>ì™„ë£Œ</option><option value="W" ${item.seenNorm==="W"?"selected":""}>ë³´ëŠ”ì¤‘</option><option value="X" ${item.seenNorm==="X"?"selected":""}>ì•ˆë´„</option>`;
        statusSelect.addEventListener("change", async(e) => {
             await updateDoc(docRef, { seen: e.target.value });
             showToast("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
        statusGroup.appendChild(statusSelect);

        // ì‹œì¦Œ/íšŒì°¨ ì„ íƒ (ê·¸ë£¹ìœ¼ë¡œ ë¬¶ìŒ)
        const epGroup = document.createElement("div"); epGroup.className = "control-group";
        // epGroup.innerHTML = `<span class="control-label">ì§„ë„</span>`;

        const seasonSelect = document.createElement("select"); seasonSelect.className = "wheel-select";
        seasonSelect.innerHTML = `<option value="-">ì‹œì¦Œ</option>` + Array.from({length:MAX_SEASON},(_,i)=>`<option value="${i+1}">${i+1}ê¸°</option>`).join('');
        seasonSelect.value = item.season ?? "-";

        const episodeSelect = document.createElement("select"); episodeSelect.className = "wheel-select";
        episodeSelect.innerHTML = `<option value="-">íšŒì°¨</option>` + Array.from({length:MAX_EPISODE},(_,i)=>`<option value="${i+1}">${i+1}í™”</option>`).join('');
        episodeSelect.value = item.episodeNum ?? "-";

        // ê³µí†µ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        const updateEpInfo = async (newSeason, newEp) => {
            const newText = buildEpisodeText(newSeason, newEp);
            await updateDoc(docRef, { season: newSeason, episodeNum: newEp, episodeText: newText });
            // showToast("íšŒì°¨ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."); // ë„ˆë¬´ ìì£¼ ë– ì„œ ì£¼ì„ ì²˜ë¦¬
        }
        seasonSelect.addEventListener("change", (e) => updateEpInfo(e.target.value==='-'?null:Number(e.target.value), episodeSelect.value==='-'?null:Number(episodeSelect.value)));
        episodeSelect.addEventListener("change", (e) => updateEpInfo(seasonSelect.value==='-'?null:Number(seasonSelect.value), e.target.value==='-'?null:Number(e.target.value)));

        epGroup.appendChild(seasonSelect);
        epGroup.appendChild(episodeSelect);

        // â˜…â˜…â˜… [+1í™” ë¹ ë¥¸ ì¶”ê°€ ë²„íŠ¼] - í•µì‹¬ ê¸°ëŠ¥ ì¶”ê°€ â˜…â˜…â˜…
        const plusOneBtn = document.createElement("button");
        plusOneBtn.className = "plus-one-btn";
        plusOneBtn.title = "ë‹¤ìŒ í™”ë¡œ ë³€ê²½ (+1)";
        plusOneBtn.textContent = "+1í™”";
        plusOneBtn.addEventListener("click", async () => {
            let currentEp = item.episodeNum ?? 0; // í˜„ì¬ íšŒì°¨ê°€ ì—†ìœ¼ë©´ 0ë¶€í„° ì‹œì‘
            let nextEp = currentEp + 1;
            // ìƒíƒœë„ 'ë³´ëŠ”ì¤‘'ìœ¼ë¡œ ìë™ ë³€ê²½
            await updateDoc(docRef, { 
                episodeNum: nextEp, 
                episodeText: buildEpisodeText(item.season, nextEp),
                seen: 'W' 
            });
            showToast(`'${item.title}' ${nextEp}í™”ë¡œ ì—…ë°ì´íŠ¸!`, 'success');
        });
        epGroup.appendChild(plusOneBtn);


        controls.appendChild(statusGroup);
        controls.appendChild(epGroup);

        // --- ë©”ëª¨ ë° í•˜ë‹¨ ---
        const memoEl = document.createElement("textarea"); memoEl.className = "memo"; memoEl.placeholder = "ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."; memoEl.value = item.memo || "";
        memoEl.addEventListener("change", async(e) => { await updateDoc(docRef, { memo: e.target.value.trim() }); showToast("ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); });

        const footer = document.createElement("div"); footer.className = "card-footer";
        footer.textContent = getCreatedAtMs(item) ? new Date(getCreatedAtMs(item)).toLocaleDateString() + " ì¶”ê°€ë¨" : "";
        
        const delBtn = document.createElement("button"); delBtn.className = "secondary danger small-btn";
        delBtn.innerHTML = `ğŸ—‘ï¸ ì‚­ì œ`;
        delBtn.addEventListener("click", async() => { if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await deleteDoc(docRef); showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "error"); }});
        footer.appendChild(delBtn);

        card.appendChild(headerRow);
        card.appendChild(controls);
        card.appendChild(memoEl);
        card.appendChild(footer);
        grid.appendChild(card);
      });
    }
  </script>
</body>
</html>
